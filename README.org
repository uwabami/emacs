#+title: Emacs の設定
# -*- mode: org; coding: utf-8-unix; indent-tabs-mode: nil -*-
#+startup: content
#+options: auto-id:t H:6
#+date: 2019-12-25 09:17:27
* はじめに
  :PROPERTIES:
  :CUSTOM_ID: org66fa74cd
  :END:
  ここでは私の Emacs の設定についてまとめています．

  #+html: <amp-img src="https://travis-ci.org/uwabami/emacs.svg?branch=master" width="72px" height="20px" layout=fixed class="travis_badge"></amp-img>
  #+html: <amp-img src="https://img.shields.io/badge/License-GPLv3-blue.svg" width="92px" height="20px" layout="fixed"></amp-img>
  #+html: <a href="https://github.com/uwabami/emacs"><span class="icon-github"><svg id="SVGRoot" width="20px" height="20px" version="1.1" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="m5.4144 12.761c0 0.0645-0.0742 0.11613-0.16774 0.11613-0.10645 0.01-0.18064-0.0419-0.18064-0.11613 0-0.0645 0.0742-0.11613 0.16774-0.11613 0.0968-0.01 0.18064 0.0419 0.18064 0.11613zm-1.0032-0.14516c-0.0226 0.0645 0.0419 0.13871 0.13871 0.15806 0.0839 0.0323 0.18064 0 0.2-0.0645 0.0194-0.0645-0.0419-0.13871-0.13871-0.16775-0.0839-0.0226-0.17742 0.01-0.2 0.0742zm1.4258-0.0548c-0.0935 0.0226-0.15806 0.0839-0.14838 0.15806 0.01 0.0645 0.0935 0.10645 0.19032 0.0839 0.0936-0.0226 0.15806-0.0839 0.14839-0.14838-0.01-0.0613-0.0968-0.10323-0.19033-0.0935zm2.1226-12.361c-4.4742 0-7.8968 3.3968-7.8968 7.871 0 3.5774 2.2516 6.6387 5.4677 7.7161 0.41291 0.0742 0.55807-0.18064 0.55807-0.39032 0-0.2-0.01-1.3032-0.01-1.9806 0 0-2.2581 0.48387-2.7323-0.96129 0 0-0.36774-0.93871-0.89677-1.1806 0 0-0.73871-0.50645 0.0516-0.49677 0 0 0.80323 0.0645 1.2452 0.83226 0.70645 1.2452 1.8903 0.88709 2.3516 0.67419 0.0742-0.51613 0.28387-0.87419 0.51613-1.0871-1.8032-0.2-3.6226-0.46129-3.6226-3.5645 0-0.8871 0.24516-1.3323 0.76129-1.9-0.0839-0.20968-0.35806-1.0742 0.0839-2.1903 0.6742-0.20967 2.2258 0.87097 2.2258 0.87097 0.64516-0.18064 1.3387-0.27419 2.0258-0.27419 0.68709 0 1.3806 0.0936 2.0258 0.27419 0 0 1.5516-1.0839 2.2258-0.87097 0.44193 1.1194 0.16774 1.9806 0.0839 2.1903 0.51613 0.57096 0.83226 1.0161 0.83226 1.9 0 3.1129-1.9 3.3613-3.7032 3.5645 0.29678 0.25484 0.54839 0.73871 0.54839 1.4968 0 1.0871-0.01 2.4322-0.01 2.6968 0 0.20968 0.14839 0.46452 0.55807 0.39032 3.2258-1.071 5.4129-4.1322 5.4129-7.7097 0-4.4742-3.629-7.871-8.1032-7.871zm-4.7613 11.126c-0.0419 0.0323-0.0323 0.10646 0.0226 0.16775 0.0516 0.0516 0.12581 0.0742 0.16775 0.0323 0.0419-0.0323 0.0323-0.10645-0.0226-0.16774-0.0516-0.0516-0.12581-0.0742-0.16775-0.0323zm-0.34838-0.26129c-0.0226 0.0419 0.01 0.0935 0.0742 0.12581 0.0516 0.0323 0.11613 0.0226 0.13871-0.0226 0.0226-0.0419-0.01-0.0935-0.0742-0.12581-0.0645-0.0194-0.11613-0.01-0.13871 0.0226zm1.0452 1.1484c-0.0516 0.0419-0.0323 0.13871 0.0419 0.2 0.0742 0.0742 0.16775 0.0839 0.20968 0.0323 0.0419-0.0419 0.0226-0.13871-0.0419-0.2-0.071-0.0742-0.16775-0.0839-0.20968-0.0323zm-0.36774-0.47419c-0.0516 0.0323-0.0516 0.11613 0 0.19032 0.0516 0.0742 0.13871 0.10645 0.18064 0.0742 0.0516-0.0419 0.0516-0.1258 0-0.2-0.0452-0.0742-0.12903-0.10645-0.18064-0.0645z" fill="currentColor" stroke-width=".032258"/></svg></span></a>

  基本方針は以下の通り:
** Debian パッケージがインストールされているならばそれを優先する
   :PROPERTIES:
   :CUSTOM_ID: org5eaa4818
   :END:
   :[[https://en.wikipedia.org/wiki/Eating_your_own_dog_food][Eating your own dog food - Wikipedia]]

   Emacsに関連するDebianパッケージを幾つかメンテナンスしているので,
   可能な限りDebianパッケージを使うことにしています．
** [[https://github.com/conao3/leaf.el][leaf.el]]でEmacs のパッケージの導入と設定を行なう
   :PROPERTIES:
   :CUSTOM_ID: orgd2ba4ef2
   :END:
   設定には[[https://github.com/conao3/leaf.el][leaf.el]]を利用します．
   VCS からインストールしたいパッケージが幾つかあるので,
   それらについては[[https://github.com/dimitri/el-get][el-get]]を利用しています．
   今後は[[https://github.com/conao3/feather.el][feather.el]]も試してみたいですね．
** 設定は [[http://orgmode.org/][Org mode]] で書きたい
   :PROPERTIES:
   :CUSTOM_ID: org458d9cf4
   :END:
   以前こんなブログ記事を書きました→ [[http://uwabami.junkhub.org/log/20111213.html#p01][Emacsの設定ファイルをorgで書く]]

   というわけで, 設定は [[http://orgmode.org/worg/org-contrib/babel/intro.html][Org Babel]] で書いています.
   本ファイル(=README.org=) から,
   Makefile 内の以下のスクリプトで =~/init.el= を生成し, byte-compile します.
   #+begin_src makefile-gmake :tangle no
EMACS   ?= emacs
init.el: README.org
    $(EMACS) -Q -q --batch --eval \
       "(progn \
          (require 'ob-tangle) \
          (org-babel-tangle-file \"$<\" \"$@\" \"emacs-lisp\"))"
    $(EMACS) -q -l init.el --batch --eval '(kill-emacs)'
%.elc: %.el
    $(EMACS) -q -l init.el -batch -f batch-byte-compile $<
   #+end_src
   ついでに, 出力される =init.el= 用のおまじない(?)として
   =lexsical-binding= を有効にしておきます．
   #+begin_src emacs-lisp
;; -*- lexical-binding: nil -*-
   #+end_src
** ディレクトリ構成の修正
   :PROPERTIES:
   :CUSTOM_ID: org60bad8a3
   :END:
   分割した設定ファイル群やパッケージでinstallしたパッケージ
   の置き場所は =user-emacs-directory= 以下にまとめています。

   ディレクトリ構成は以下のようにしました:
   #+begin_example
    ~/.emacs.d/
     |-- Makefile    ←  byte-compile 用の rule
     |-- README.org  ←  本ファイル．`org-babel-tangle' で init.el を生成
     |-- pkg
     |   |-- elpa/   ←  package.el で導入したパッケージが置かれる場所
     |   `-- el-get/ ←  el-get で導入したパッケージが置かれる場所
     |-- share/      ←  (基本的に)参照するだけの資源置き場所
     `-- tmp/        ←  一次ファイルの置き場所
   #+end_example
   上記ディレクトリ構成を設定ファイルで使用するために
   ディレクトリ配置を宣言しておきます。
   #+begin_src emacs-lisp
(when load-file-name
  (setq user-emacs-directory
        (expand-file-name (file-name-directory load-file-name))))
(defconst my:d:share
  (expand-file-name "share/" user-emacs-directory))
(defconst my:d:tmp
  (expand-file-name "tmp/" user-emacs-directory))
(defconst my:d:pkg:elpa
  (expand-file-name "pkg/elpa" user-emacs-directory))
(defconst my:d:pkg:elget
  (expand-file-name "pkg/el-get" user-emacs-directory))
(dolist (my:d '(my:d:share
                my:d:tmp
                my:d:pkg:elpa
                my:d:pkg:elget))
  (lambda ()
    (unless (file-directory-p my:d)
      (make-directory my:d t))))
   #+end_src
   その他, 良く使うディレクトリもここで設定しておきます．
   #+BEGIN_SRC emacs-lisp
(defconst my:d:org (concat (getenv "HOME") "/Nextcloud/org/"))
   #+END_SRC
** Byte-Compile 時の Common Lisp の読み込み
   :PROPERTIES:
   :CUSTOM_ID: org87c9febb
   :END:
   幾つかん関数で =Common-Lisp= 的挙動が期待されているので,
   =cl-lib= を読み込んでおきます．
   #+begin_src emacs-lisp
(eval-when-compile (require 'cl-lib nil t))
   #+end_src
* Package 関連: =package.el=, [[https://github.com/conao3/leaf.el][leaf.el]], [[https://github.com/dimitri/el-get][el-get]]
  :PROPERTIES:
  :CUSTOM_ID: orgcf4176e7
  :END:
  [[https://github.com/conao3/leaf.el][leaf.el]]のおかげで,
  無いと途方に暮れるパッケージ以外のインストールは無視できるようになります.
** TODO =package.el= [0/1]
   :PROPERTIES:
   :CUSTOM_ID: orgc51eb87d
   :END:
   パッケージは基本的に =pacakge.el= で導入するので, 先ずはその設定.
   #+begin_src emacs-lisp
(require 'package nil 'noerror)
;; elpa/gnutls workaround
(if (string< emacs-version "26.3")
    (setq gnutls-algorithm-priority "NORMAL:-VERS-TLS1.3"))
(setq package-enable-at-startup t
      package-user-dir my:d:pkg:elpa
      package-gnupghome-dir (expand-file-name ".gnupg" (getenv "HOME"))
      )
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(eval-when-compile
  (unless (file-exists-p (locate-user-emacs-file "tmp/bootstrap-stamp"))
    (package-refresh-contents)
    (with-temp-buffer (write-file (locate-user-emacs-file "tmp/bootstrap-stamp")))
    ))
(package-initialize)
   #+end_src
   - [ ] で, elpa の SSL error の workaround は正しくはどうするの?
** [[https://github.com/conao3/leaf.el][leaf.el]]
   :PROPERTIES:
   :CUSTOM_ID: orgc2ededbf
   :END:
   個々のパッケージの設定には[[https://github.com/conao3/leaf.el][leaf.el]]を利用します.
   自分で修正した版やオリジナル版を別の場所から持ってくる場合は
   [[https://github.com/conao3/leaf.el][leaf.el]]から[[https://github.com/dimitri/el-get][el-get]]を呼び出します.
   #+BEGIN_SRC emacs-lisp
     (unless (package-installed-p 'leaf)
       (package-install 'leaf t))
     (require 'leaf nil 'noerror)
     (leaf leaf-keywords
       :ensure t
       :init
       (leaf diminish :ensure t)
       (leaf delight  :ensure t)
       (leaf el-get
         :ensure t
         :require t
         :preface
         (defconst el-get-dir my:d:pkg:elget) ;; override el-get default
         :custom ((el-get-notify-type       . 'message)
                  (el-get-git-shallow-clone . t))
         )
       :config
       (leaf-keywords-init)
       )
   #+end_src
* =exec-path-from-shell=: 環境変数の読み込み
  :PROPERTIES:
  :CUSTOM_ID: org9abae8f2
  :END:
  shell(zsh)で設定した =PATH= などの環境変数をEmacsに引き継ぐために
  [[https://github.com/purcell/exec-path-from-shell][purcell/exec-path-from-shell]] を使います.
  今の所
  - =SHELL=
  - =DEBFULLNAME=
  - =DEBEMAIL=
  - =TEXMFHOME=
  - =SKKSERVER=
  - =http_proxy=
  - =GPG_KEY_ID=
  - =GPG_AGENT_INFO=
  - =PASSWORD_STORE_DIR=
  - =PATH=
  を読み込んでいます(多いな...).
  #+begin_src emacs-lisp
(leaf exec-path-from-shell
  :ensure t
  :defun (exec-path-from-shell-initialize)
  :custom
  ((exec-path-from-shell-check-startup-files . nil)
   (exec-path-from-shell-variables .  '("SHELL"
                                        "DEBFULLNAME"
                                        "DEBEMAIL"
                                        "SKKSERVER"
                                        "TEXMFHOME"
                                        "http_proxy"
                                        "GPG_KEY_ID"
                                        "GPG_AGENT_INFO"
                                        "PASSWORD_STORE_DIR"
                                        "PATH")))
  :config
  (exec-path-from-shell-initialize)
  (setq user-full-name    (concat (getenv "DEBFULLNAME"))
        user-mail-address (concat (getenv "DEBEMAIL")))
  (defconst my:d:password-store
    (if (getenv "PASSWORD_STORE_DIR")
        (expand-file-name (concat "Emacs/" (system-name))
                          (getenv "PASSWORD_STORE_DIR")))
    nil)
  )
  #+end_src
* 独自関数
  :PROPERTIES:
  :CUSTOM_ID: org34ff2306
  :END:
  細かい独自関数, など．
** dpkg-status
   :PROPERTIES:
   :CUSTOM_ID: orgc5559fad
   :END:
   もっと良い方法がありそうなモンですが．
   #+begin_src emacs-lisp
(defun my:dpkg-status (package)
  "Return the `PACKAGE' status from dpkg --get-selections."
  (string-match "^ii" (shell-command-to-string (format "dpkg -l %s" package))))
   #+end_src
** ファイル名を minibuffer におさまる様に整形
   :PROPERTIES:
   :CUSTOM_ID: org452a76a8
   :END:
   zsh prompt風味．
   #+begin_src emacs-lisp
(defun my:shorten-file-path (fpath max-length)
  "Show up to `max-length' characters of a directory name `fpath' like zsh"
  (let* ((path (reverse (split-string (abbreviate-file-name fpath) "/")))
         (output "")
         (top (mapconcat 'identity (reverse (last path 3)) "/"))
         (vmax (- max-length 4 (length top)))
         (path (butlast path 3))
         )
    (while (and path
                (and (< (length output) vmax)
                     (< (length (concat "/" (car path) output)) vmax)))
      (setq output (concat "/" (car path) output))
      (setq path (cdr path)))
    ;; 省略
    (when path
      (setq output (concat "/..." output)))
    (format "%s%s" top output)))
   #+end_src
** 空になったファイルを尋ねずに自動削除
   :PROPERTIES:
   :CUSTOM_ID: org5b521483
   :END:
   ゴミが残らないし, 地味に便利．
   #+begin_src emacs-lisp
(leaf *delete-file-if-no-contents
  :preface (defun my:delete-file-if-no-contents ()
             (when (and (buffer-file-name (current-buffer))
                        (= (point-min) (point-max)))
               (delete-file
                (buffer-file-name (current-buffer)))))
  :config
  (if (not (memq 'my:delete-file-if-no-contents after-save-hook))
      (setq after-save-hook
            (cons 'my:delete-file-if-no-contents after-save-hook)))
  )
   #+end_src
** scratch を殺さない. 消したら再生成
   :PROPERTIES:
   :CUSTOM_ID: orge279b0e0
   :END:
   ...元ネタがどこだったのか忘れてしまった...
   #+begin_src emacs-lisp
(leaf *keepscratchbuffer
  :preface
  (defun my:make-scratch (&optional arg)
    (interactive)
    (progn
      ;; "*scratch*" を作成して buffer-list に放り込む
      (set-buffer (get-buffer-create "*scratch*"))
      (funcall initial-major-mode)
      (erase-buffer)
      (when (and initial-scratch-message (not inhibit-startup-message))
        (insert initial-scratch-message))
      (or arg
          (progn
            (setq arg 0)
            (switch-to-buffer "*scratch*")))
      (cond ((= arg 0) (message "*scratch* is cleared up."))
            ((= arg 1) (message "another *scratch* is created")))))
  ;;
  (defun my:buffer-name-list ()
    (mapcar (function buffer-name) (buffer-list)))
  :hook  ((kill-buffer-query-functions
           . (lambda ()
               (if (string= "*scratch*" (buffer-name))
                   (progn (my:make-scratch 0) nil)
                 t)))
          (after-save-hook
           . (lambda ()
               (unless (member "*scratch*" (my:buffer-name-list))
                 (my:make-scratch 1)))))
  )
   #+end_src
** 行末の無駄な空白/改行を削除する
   :PROPERTIES:
   :CUSTOM_ID: org1effd724
   :END:
   @see [[http://d.hatena.ne.jp/tototoshi/20101202/1291289625][無駄な行末の空白を削除する(Emacs Advent Calendar jp:2010)]]

   ただし, RD や Markdown だと空白行に意味があったりするので,
   必要に応じて拡張子で判断して外している．
   #+begin_src emacs-lisp
(leaf *trailing-white-space
  :preface
  (defvar my:delete-trailing-whitespace-exclude-suffix
    (list "\\.rd$" "\\.md$" "\\.rbt$" "\\.rab$"))
  (defun my:delete-trailing-whitespace ()
    (interactive)
    (eval-when-compile (require 'cl-lib))
    (cond
     ((equal nil
             (cl-loop for pattern in my:delete-trailing-whitespace-exclude-suffix
                      thereis (string-match pattern buffer-file-name)))
      (delete-trailing-whitespace))))
  :hook (before-save-hook . my:delete-trailing-whitespace)
  )
   #+end_src
* 主にEmacs本体, および同梱されている拡張に関する設定
  :PROPERTIES:
  :CUSTOM_ID: org1927da44
  :END:
** 終了時に =custom.el= を消す
   :PROPERTIES:
   :CUSTOM_ID: orgd140a191
   :END:
   設定ファイルに極力移す.
   #+BEGIN_SRC emacs-lisp
(leaf cus-edit
  :preface
  (setq custom-file (expand-file-name "custom.el" my:d:tmp))
  :custom
  `((custom-file . ,(expand-file-name "custom.el" my:d:tmp)))
  :hook
  `((kill-emacs-hook . (lambda ()
                         (if (file-exists-p custom-file)
                             (delete-file custom-file)))))
  )
   #+END_SRC
** =customize= で設定していたアレコレ
   :PROPERTIES:
   :CUSTOM_ID: orgaee31636
   :END:
   =custom.el= にある設定は極力こちらに移すようにしている.
   - =gc-cons-threshold= はとりあえず default の設定に.
     メモリ喰いな拡張を入れている場合には,
     安易に =gc-cons-threshold= を上げるのは考えものである.
     「gc が走る→大きな領域を掃除するのでその間 emacs が止まる」
     という事を頻繁に経験することになるだろう.
   - 大抵の場合ターミナル内で =-nw= として起動するし,
     メニューは触ったことないので使わないので,
     フレーム, ツールバー等を非表示にする．
   - =.elc= と =.el= の timestamp を比較し, 新しい方を読み込む
    (=load-prefer-newer= は Emacs >= 24.4 から).
   - yes or no を y or n に
   他にもイロイロと. 設定が増えてきたら分ける.
  #+BEGIN_SRC emacs-lisp
(leaf cus-start
  :custom
  `(;; gc
    (gc-cons-threshold       . ,(* 8 1024 1024))
    (garbage-collection-messages . nil)
    ;; 表示
    (tool-bar-mode          . nil)  ; 基本 "-nw" なので不要
    (scroll-bar-mode        . nil)  ; 基本 "-nw" なので不要
    (menu-bar-mode          . nil)  ; 基本 "-nw" なので不要
    (blink-cursor-mode      . nil)  ; 基本 "-nw" なので不要
    (column-number-mode     . nil)  ; 基本 "-nw" なので不要
    (ring-bell-function     . 'ignore)   ; ベル無効化
    ;; 編集
    (tab-width              . 4)    ;; tab 幅 4
    (indent-tabs-mode       . nil)  ;; tab ではインデントしない
    (fill-column            . 72)   ;; RFC2822 風味
    (truncate-lines         . nil)  ;; 折り返し無し
    (truncate-partial-width-windows . nil)
    (paragraph-start        . '"^\\([ 　・○<\t\n\f]\\|(?[0-9a-zA-Z]+)\\)")
    (auto-fill-mode         . nil)
    (next-line-add-newlines . nil)  ;; バッファ終端で newline を入れない
    (read-file-name-completion-ignore-case . t)  ; 大文字小文字区別無し
    ;; backup
    (auto-save-list-file-prefix . ,(concat my:d:tmp ".saves-"))
    (auto-save-default       . t)
    (auto-save-timeout       . 15)
    (auto-save-interval      . 60)
    (make-backup-files       . t)
    (backup-by-copying       . t)  ;; symlink は使わない
    (backup-directory-alist  . '(("." . ,my:d:tmp)))
    (auto-save-file-name-transforms . '((".*" ,my:d:tmp t)))
    (version-control         . t)
    (kept-new-versions       . 5)
    (kept-old-versions       . 5)
    (delete-old-versions     . t)
    (delete-auto-save-files  . t)
    ;; undo/redo - 数字に根拠無し
    (undo-limit              . 200000)
    (undo-strong-limit       . 260000)
    (history-length          . t)  ;; 無制限(の筈)
    )
  :config
  (when (boundp 'load-prefer-newer)
    (setq load-prefer-newer t))
  ;; yes or no を y or n に
  (fset 'yes-or-no-p 'y-or-n-p)
  )
  #+END_SRC
** =startup=: 起動は静かに
   :PROPERTIES:
   :CUSTOM_ID: org9eac26e0
   :END:
  #+BEGIN_SRC emacs-lisp
(leaf startup
  :custom
  ((inhibit-startup-screen            . t)
   (inhibit-startup-message           . t)
   (inhibit-startup-echo-area-message . t)
   (initial-scratch-message           . nil)
   )
  )
  #+END_SRC
** =hl-mode=: 現在行のハイライト
   :PROPERTIES:
   :CUSTOM_ID: org58ba514c
   :END:
  #+BEGIN_SRC emacs-lisp
(leaf hl-line
  :hook
  (emacs-startup-hook . global-hl-line-mode)
  )
  #+END_SRC
** 選択リージョンに色付け
   :PROPERTIES:
   :CUSTOM_ID: orgd5c20561
   :END:
  #+BEGIN_SRC emacs-lisp
(leaf simple
  :hook
  (emacs-startup-hook . transient-mark-mode)
  )
  #+END_SRC
** =show-paren-mode=: 対応する括弧を強調表示
   :PROPERTIES:
   :CUSTOM_ID: org281c29f0
   :END:
  #+BEGIN_SRC emacs-lisp
(leaf paren
  :custom
  ((show-paren-style  . 'mixed))
  :hook
  (emacs-startup-hook . show-paren-mode)
  )
  #+END_SRC
** =linum-mode= : 行番号表示
   :PROPERTIES:
   :CUSTOM_ID: orgdd3a7c08
   :END:
   必要に応じて有効にするので, 基本使わない.
   通常はモードラインに行番号や桁番号を表示しないようする.
   ついでに =linum-mode= を有効にした場合の桁表示を 5 桁に.
  #+BEGIN_SRC emacs-lisp
(leaf line-number-mode
  :custom
  ((linum-format     . "%5d ")
   (line-number-mode . nil))
  )
  #+END_SRC
** byte-compile 関連
   :PROPERTIES:
   :CUSTOM_ID: org45fe96c0
   :END:
  - debug は表示しない: 必要に応じて t に変更する
  - Compile-Log の非表示:     ほとんど見ないし．
  - Warning の抑制: これもほとんど見ないし．
  他にも増えそうだが
  #+BEGIN_SRC emacs-lisp
(leaf *byte-compile
  :init
  (leaf development
    :custom
    ((debug-on-error        . nil)
     (byte-compile-warnings . '(not
                                free-vars
                                unresolved
                                callargs
                                redefine
                                ;;        obsolete
                                noruntime
                                cl-functions
                                interactive-only
                                make-local)
                            )
     )
    :config
    (let ((win (get-buffer-window "*Compile-Log*")))
      (when win (delete-window win)))
    )
  )
  #+END_SRC
** =autorevert=: ファイルが変更されたら再読み込み
   :PROPERTIES:
   :CUSTOM_ID: org41afd6b6
   :END:
  #+BEGIN_SRC emacs-lisp
(leaf autorevert
  :hook
  ((emacs-startup-hook . global-auto-revert-mode))
  )
  #+END_SRC
** =savehist=: 変更履歴を保存
   :PROPERTIES:
   :CUSTOM_ID: org246148ce
   :END:
  #+BEGIN_SRC emacs-lisp
(leaf savehist
  :custom
  `((savehist-file   . ,(expand-file-name "history" my:d:tmp)))
  :hook
  ((emacs-startup-hook . savehist-mode))
  )
  #+END_SRC
** ファイル, デイレクトリ整理
   :PROPERTIES:
   :CUSTOM_ID: org35f3de20
   :END:
   =~/.emacs.d/= 以下にファイルが転がるのがなんか嫌なので,
   気がつく度に設定している.
   #+begin_src emacs-lisp
(leaf *change-default-file-location
  :custom
  `(;; url
    (url-configuration-directory . ,(expand-file-name "url" my:d:tmp))
    ;; nsm
    (nsm-settings-file . ,(expand-file-name "nsm.data" my:d:tmp ))
    ;; bookmark
    (bookmark-default-file . ,(expand-file-name "bookmarks" my:d:share))
    ;; eshell
    (eshell-directory-name . ,(expand-file-name "eshell" my:d:tmp))
    )
  )
   #+end_src
   他にもイロイロありそう．
   =bookmark= はちゃんと使いこなしたい所ではあるが．
** =eldoc=: emacs-lisp document
   :PROPERTIES:
   :CUSTOM_ID: org6a5a84f9
   :END:
   minibuffer では eldoc にお黙り頂く。
   #+begin_src emacs-lisp
(leaf eldoc
  :hook (emacs-lisp-mode-hook . turn-on-eldoc-mode)
  :diminish (eldoc-mode "")
  :preface
  (defun my:shutup-eldoc-message (f &optional string)
    (unless (active-minibuffer-window)
      (funcall f string)))
  :advice (:around eldoc-message
                   my:shutup-eldoc-message)
  )
   #+end_src
** =midnight=: 一定期間使用しなかった buffer を自動削除
   :PROPERTIES:
   :CUSTOM_ID: org2157dacb
   :END:
   #+begin_src emacs-lisp
(leaf midnight
  :config
  (setq clean-buffer-list-delay-general 1))
   #+end_src
** =uniquify=: モードラインのファイル名にディレクトリも表示する
   :PROPERTIES:
   :CUSTOM_ID: org9a0cf611
   :END:
   #+begin_src emacs-lisp
(leaf uniquify
  :config
  (setq uniquify-buffer-name-style 'post-forward-angle-brackets
        uniquify-min-dir-content 1
        )
  )
   #+end_src
** =whitespace=: 空白の強調表示
   :PROPERTIES:
   :CUSTOM_ID: org68c5e01b
   :END:
   背景も変えようかなぁ...
   #+begin_src emacs-lisp
(leaf whitespace
  :diminish ((global-whitespace-mode "")
             (whitespace-mode "")
             )
  :hook (after-init-hook . global-whitespace-mode)
  :init
  (setq whitespace-line-column 72
        whitespace-style '(face        ; faceを使って視覚化する．
                           trailing    ; 行末の空白を対象とする．
                           tabs        ; tab
                           spaces      ; space
                           )
        whitespace-display-mappings '((space-mark ?\u3000 [?\□])
                                      (tab-mark ?\t [?\u00BB ?\t] [?\\ ?\t]))
        whitespace-space-regexp "\\(\u3000+\\)"
        whitespace-global-modes '(not eww-mode
                                      term-mode
                                      eshell-mode
                                      org-agenda-mode
                                      calendar-mode)
        )
  )
   #+end_src
** =saveplace=: 前回の修正位置を記憶する.
   :PROPERTIES:
   :CUSTOM_ID: org285d3b12
   :END:
   記憶の保存先を =~/.emacs.d/tmp/emacs-places= に変更.
   #+begin_src emacs-lisp
(leaf saveplace
  :custom
  `((save-place . t)
    (save-place-file  . ,(expand-file-name "emacs-places"  my:d:tmp))
    )
  :hook (after-init-hook . save-place-mode)
  )
   #+end_src
** =time-stamp=: 保存時に timestamp を自動更新
   :PROPERTIES:
   :CUSTOM_ID: orgd064b693
   :END:
   デフォルトではいろいろと衝突したので
   更新文字列を変更し,  =＄Lastupdate: 2= (＄は半角) があったら
   timestamp を更新する様にした．
   #+begin_src emacs-lisp
(leaf time-stamp
  :hook (before-save-hook . time-stamp)
  :custom
  ((time-stamp-active     . t)
   (time-stamp-line-limit . 10)
   (time-stamp-start      . "$Lastupdate: 2")
   (time-stamp-end        . "\\$")
   (time-stamp-format     . "%03y-%02m-%02d %02H:%02M:%02S")
   )
  )
   #+end_src
   モード独自の設定(例えば Org とか)に関しては別途．
** SOMEDAY =tramp=: ssh 越しにファイルを編集 [0/1]
   :PROPERTIES:
   :CUSTOM_ID: org04853162
   :END:
   #+begin_src emacs-lisp
(leaf tramp
  :preface
  (setq tramp-persistency-file-name (expand-file-name "tramp" my:d:tmp))
  :custom
  `((tramp-persistency-file-name
     . ,(expand-file-name "tramp" my:d:tmp))
    (tramp-completion-reread-directory-timeout . nil)
    )
  :hook
  (kill-emacs-hook . (lambda ()
                       (if (file-exists-p custom-file)
                           (delete-file tramp-persistency-file-name))))
  )
   #+end_src
   - [ ] 偶に挙動不審
** TODO =eww=: 内蔵ブラウザ [0/3]
   :PROPERTIES:
   :CUSTOM_ID: org35bd4bc4
   :END:
   リンクを簡単に辿る(Hit-a-Hint) のために =ace-link= も入れておく
    #+begin_src emacs-lisp
(leaf eww
  :defvar (shr-put-image-function
           shr-external-browser)
  :preface
  (unless (file-directory-p (expand-file-name "eww" my:d:tmp))
    (make-directory (expand-file-name "eww" my:d:tmp)))
  :init
  (leaf ace-link
    :ensure t
    :config
    (ace-link-setup-default)
    )
  :bind (("<f2>" . eww)
         (:eww-mode-map
          ("r"   . eww-reload)
          ("o"   . eww)
          ("&"   . eww-browse-with-external-browser)
          ("b"   . eww-back-url)
          ("]"   . eww-next-url)
          ("["   . eww-previous-url)
          ("g"   . eww-top-url)
          ("+"   . my:eww-increase-width)
          ("-"   . my:eww-decrease-width)
          ("h"   . backward-char)
          ("j"   . next-line)
          ("k"   . previous-line)
          ("l"   . forward-char)
          ("/"   . isearch-forward)
          ("?"   . isearch-backward)
          ("n"   . isearch-next)
          ("N"   . isearch-previous)
          ("f"   . ace-link-eww))
         )
  :init
  ;;
  (defun eww-disable-images ()
    "ewwで画像表示させない"
    (interactive)
    (setq-local shr-put-image-function 'shr-put-image-alt)
    (eww-reload))
  ;;
  (defun eww-enable-images ()
    "ewwで画像表示させる"
    (interactive)
    (setq-local shr-put-image-function 'shr-put-image)
    (eww-reload))
  (defun shr-put-image-alt (spec alt &optional flags)
    (insert alt))
  ;;
  (setq eww-bookmarks-directory (expand-file-name "eww" my:d:tmp)
        eww-search-prefix "https://www.google.co.jp/search?btnl&q="
        shr-use-colors nil
        shr-use-fonts nil
        shr-width 72
        )
  ;;
  (defun eww-mode-hook--disable-image ()
    (setq-local shr-put-image-function 'shr-put-image-alt))
  (add-hook 'eww-mode-hook 'eww-mode-hook--disable-image)
  )
    #+end_src
    - [ ] 背景色の指定
    - [ ] 幅の強制
** =browse-url=
   :PROPERTIES:
   :CUSTOM_ID: org456d3821
   :END:
   ブラウザ呼び出しは =xdg-open/open= に丸投げ.
   #+begin_src emacs-lisp
(leaf browse-url
  :require t
  :bind ("C-c C-j" . browse-url-at-point)
  :config
  (cond ((executable-find "xdg-open")
         (setq browse-url-browser-function 'browse-url-xdg-open
               shr-external-browser 'browse-url-xdg-open))
        ((eq system-type 'darwin)
         (setq browse-url-browser-function 'browse-url-default-macosx-browser
               shr-external-browser 'browse-url-default-macosx-browser))
        (t
         ;; (setq browse-url-browser-function 'w3m-browse-url)
         (setq browse-url-browser-function 'eww-browse-url)
         ))
  )
   #+end_src
** =server=: Emacs server
   :PROPERTIES:
   :CUSTOM_ID: org931fd3cc
   :END:
   #+begin_src emacs-lisp
(leaf server
  :require t
  :config
  (unless (server-running-p)
    (server-start))
  )
   #+end_src
** buffer の印刷
   :PROPERTIES:
   :CUSTOM_ID: orgdd48e2df
   :END:
   #+BEGIN_SRC emacs-lisp
(leaf ps-mule
  :custom
  ((ps-multibyte-buffer . 'non-latin-printer))
  :config
  (defalias 'ps-mule-header-string-charset 'ignore)
  )
   #+END_SRC
* 認証関連: =plstore=, =password-store= など
  :PROPERTIES:
  :CUSTOM_ID: org1a8b35da
  :END:
  - =leaf-plstore= で =plstore= が使えるようになったので,
    その設定をしておく.
  - =auth-password-store= で auth-source として =password-store= を使う.
  といった事をしている.
  #+BEGIN_SRC emacs-lisp
(leaf *authentication
  :if (and (getenv "GPG_KEY_ID")
           (file-directory-p my:d:password-store))
  :preface
  (setq leaf-default-plstore
        (plstore-open
         (expand-file-name "plstore.plist" my:d:password-store)))
  :init
  (leaf password-store :ensure t)
  (leaf auth-source-pass :ensure t)
  (leaf plstore
    :custom
    `((plstore-secret-keys . 'silent)
      (plstore-encrypt-to  . ,(getenv "GPG_KEY_ID")))
    )
  )
  #+END_SRC
* =recentf=: 最近使ったファイル履歴の保管
  :PROPERTIES:
  :CUSTOM_ID: org43970469
  :END:
  ファイルを開く際には =my:counsel-recentf= を使うので,
  結局履歴を貯める設定をしている事になっている.
  ディレクトリの履歴も取れるので recentf-ext を入れておく
  #+begin_src emacs-lisp
(leaf recentf
  :defun
  (recentf-save-list recentf-cleanup)
  :preface
  (leaf shut-up
    :ensure t
    :init
    (defvar shut-up-ignore t))
  (defun my:recentf-save-list-silence ()
    "Shut up"
    (interactive)
    (let ((message-log-max nil))
      (shut-up (recentf-save-list)))
    (message ""))
  ;;
  (defun my:recentf-cleanup-silence ()
    "Shut up"
    (interactive)
    (let ((message-log-max nil))
      (shut-up (recentf-cleanup)))
    (message ""))
  ;;
  :init
  (leaf recentf-ext :ensure t)
  :hook
  ((after-init-hook . recentf-mode)
   (focus-out-hook  . my:recentf-save-list-silence)
   (focus-out-hook  . my:recentf-cleanup-silence))
  :custom
  `((recentf-save-file       . ,(expand-file-name "recentf" my:d:tmp))
    (recentf-max-saved-items . 128)
    (recentf-auto-cleanup    . 'never)
    (recentf-exclude         . '(".recentf"
                                 "^/tmp\\.*"
                                 "^/private\\.*"
                                 "^/var/folders\\.*"
                                 "/TAGS$"
                                 "\\.*草稿\\.*"
                                 "^#\\.*"
                                 "^/home/uwabami/.mozilla/\\.*"
                                 "^/home/uwabami/.emacs.d/tmp/\\.*"
                                 "^/[^/:]+:"
                                 "bookmarks"
                                 "org-recent-headings.dat"
                                 )))
  )
  #+end_src
* SOMEDAY 言語の設定 [0/1]
  :PROPERTIES:
  :CUSTOM_ID: orgadf8c6bf
  :END:
  最近のEmacsはlocaleから文字コードを自動判別するらしいので,
  以前良く設定していた以下は不要らしいですね(ホントかな...?)。
  #+begin_src emacs-lisp :tangle no
(set-language-environment "Japanese")
(prefer-coding-system 'utf-8)
(set-file-name-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-default 'buffer-file-coding-system 'utf-8)
  #+end_src
  - [ ] m17n.org の消滅によって, 参照元が消えた。適切な参照元はどこだろうか。
** cp5022x.el
   :PROPERTIES:
   :CUSTOM_ID: org58d8e6f8
   :END:
   Emacs23 から内部が Unicode ベースになっています。

   しかし文字コードの変換はGNU libcのiconvをベースにしているため,
   機種依存文字を含む文字コードの変換をうまく行なえません。
   そこで言語設定前に =cp5022x.el= をインストールすることにしています。
   #+begin_src emacs-lisp
(leaf cp5022x
  :ensure t
  :require t
  :config
  (set-charset-priority 'ascii 'japanese-jisx0208 'latin-jisx0201
                        'katakana-jisx0201 'iso-8859-1 'unicode)
  (set-coding-system-priority 'utf-8 'euc-jp 'iso-2022-jp 'cp932)
  )
   #+end_src
* =all-the-icons-in-terminal=: ターミナルでもicon fontを使いたい。
  :PROPERTIES:
  :CUSTOM_ID: orgd903bf1d
  :END:
  [[https://github.com/domtronn/all-the-icons.el][all-the-icons.el]]のデータを修正して,
  [[https://github.com/sebastiencs/icons-in-terminal][icons in terminal]]を修正した
  自作フォントのデータを読みに行くようにしてみました。
  #+begin_src emacs-lisp
(leaf all-the-icons
  :ensure t
  :require t
  :custom
  ((all-the-icons-scale-factor   . 0.9)
   (all-the-icons-default-adjust . 0.0))
  )
(leaf all-the-icons-in-terminal
  :el-get (all-the-icons-in-terminal
           :type github
           :pkgname "uwabami/isfit-plus")
  :after all-the-icons
  :require t
  :config
  (add-to-list 'all-the-icons-mode-icon-alist
               '(f90-mode all-the-icons-faicon "facebook")) ;; facebook!?
  (add-to-list 'all-the-icons-mode-icon-alist
               '(wl-folder-mode all-the-icons-faicon "folder-o" ))
  (add-to-list 'all-the-icons-mode-icon-alist
               '(wl-summary-mode all-the-icons-faicon "folder-open-o"))
  (add-to-list 'all-the-icons-mode-icon-alist
               '(wl-draft-mode all-the-icons-material "drafts"))
  (add-to-list 'all-the-icons-mode-icon-alist
               '(mime-view-mode all-the-icons-faicon "envelope-o"))
  )
  #+end_src
** TODO East Asian Ambiguos 対応 [0/1]
   :PROPERTIES:
   :CUSTOM_ID: orgd3ca00ac
   :END:
   East Asian Ambiguosを2文字幅にして, ついでに
   CJK 以外の East Asian Ambiguosと絵文字も2文字幅にするようにしています。
   拙作の修正ロケールはこちら: [[https://github.com/uwabami/locale-eaw-emoji]]
   #+begin_src emacs-lisp
(leaf locale-eaw-emoji
  :el-get (locale-eaw-emoji
           :type github
           :pkgname "uwabami/locale-eaw-emoji")
  :after all-the-icons-in-terminal
  :require t
  :config
  (eaw-and-emoji-fullwidth)
  )
   #+end_src
   - [ ] 最近, EAWは一文字幅強制の方が良いかなぁ, とか悩み中.
** macOS対応
   :PROPERTIES:
   :CUSTOM_ID: orgcf967538
   :END:
   最近良く触る様になったので設定している。
   +まあ, イマイチ慣れない訳ですけれど+
   #+begin_src emacs-lisp
(leaf *mac-encoding
  :if (eq system-type 'darwin)
  (leaf ucs-normalize
    :require t
    :defvar (mac-pass-control-to-system ns-command-modifier ns-alternate-modifier)
    :config
    (set-file-name-coding-system 'utf-8-hfs)
    (setq locale-coding-system 'utf-8-hfs)
    (setq mac-pass-control-to-system t  ;; Ctrl を Mac から奪い取る
          ns-command-modifier 'meta     ;; Cmd と Option を逆にする
          ns-alternate-modifier 'super)
    (global-set-key [ns-drag-file] 'ns-find-file)
    )
  )
   #+end_src
** カレンダー設定
   :PROPERTIES:
   :CUSTOM_ID: org7d9d4027
   :END:
   表示の更新と =japanese-holidays= による日本の休日の追加
   #+BEGIN_SRC emacs-lisp
(leaf calendar
  ;; :require t
  :custom
  (;; 祝日をカレンダーに表示
   (mark-holidays-in-calendar . t)
   ;; 月と曜日の表示調整
   (calendar-month-name-array . ["01" "02" "03" "04" "05" "06"
                                 "07" "08" "09" "10" "11" "12" ])
   (calendar-day-name-array   . ["日" "月" "火" "水" "木" "金" "土"])
   (calendar-day-header-array . ["日" "月" "火" "水" "木" "金" "土"])
   ;; 日曜開始
   (calendar-week-start-day   . 0))
  )
(leaf japanese-holidays
  :ensure t
  :after calendar
  :hook ((calendar-today-visible-hook   . japanese-holiday-mark-weekend)
         (calendar-today-invisible-hook . japanese-holiday-mark-weekend)
         (calendar-today-visible-hook   . calendar-mark-today))
  :custom
  ((japanese-holiday-weekend         . '(0 6))
   (japanese-holiday-weekend-marker  . '(holiday  ;; 日
                                         nil      ;; 月
                                         nil      ;; 火
                                         nil      ;; 水
                                         nil      ;; 木
                                         nil      ;; 金
                                         japanese-holiday-saturday)))
  :config
  ;; これは最後にやらないとだめ? with-eval-after-load 的な?
  (setq calendar-holidays (append japanese-holidays holiday-local-holidays))
  )
   #+END_SRC
* キーバインドの設定
  :PROPERTIES:
  :CUSTOM_ID: org8aa6f45e
  :END:
  既に手癖になってしまっているアレコレ．
  特に =[home]= と =[end]= は無いと途方に暮れます．
  #+begin_src emacs-lisp
(leaf-keys (("C-h"     . backward-delete-char)
            ("C-c M-a" . align-regexp)
            ("C-c ;"   . comment-region)
            ("C-c M-;" . uncomment-region)
            ("C-/"     . undo)
            ("C-c M-r" . replace-regexp)
            ("C-c r"   . replace-string)
            ("<home>"  . beginning-of-buffer)
            ("<end>"   . end-of-buffer)
            ("C-c M-l" . toggle-truncate-lines)))
  #+end_src
* =migemo=: インクリメンタル検索
  :PROPERTIES:
  :CUSTOM_ID: org5d9ade19
  :END:
  無いと途方に暮れる．
  #+begin_src emacs-lisp
(leaf migemo
  :if (executable-find "cmigemo")
  :ensure t
  :require t
  :custom
  '((migemo-user-dictionary  . nil)
    (migemo-regex-dictionary . nil)
    (migemo-options          . '("-q" "--emacs"))
    (migemo-command          . "cmigemo")
    (migemo-coding-system    . 'utf-8-unix))
  :init
  (cond
   ((and (eq system-type 'darwin)
         (file-directory-p "/usr/local/share/migemo/utf-8/"))
    (setq migemo-dictionary "/usr/local/share/migemo/utf-8/migemo-dict"))
   (t
    (setq migemo-dictionary "/usr/share/cmigemo/utf-8/migemo-dict")))
  :config
  (migemo-init)
  )
  #+end_src
* 補完: =ivy=, =counsel=,  =swiper= [/]
  :PROPERTIES:
  :CUSTOM_ID: org523a6f47
  :END:
  以前は =ido= を使っていたのでまだ挙動に戸惑う事があるけれど．
  - [[https://qiita.com/takaxp/items/2fde2c119e419713342b][helm を背に ivy の門を叩く - Qiita]] を参考の事.
** =ivy=: 補完の基本設定
   :PROPERTIES:
   :CUSTOM_ID: org829c7d26
   :END:
   #+BEGIN_SRC emacs-lisp
(leaf ivy
  :ensure t
  :init
  (leaf flx :ensure t)
  (leaf smex
    :ensure t
    :custom
    `((smex-save-file
       . ,(expand-file-name "smex-items" my:d:tmp))
      (smex-history-length . 32)
      )
    )
  (leaf ivy-hydra :ensure t)
  :preface
  ;; 補完候補のアイコン表示
  (defface my:ivy-arrow-visible
    '((((class color) (background light)) :foreground "#FFBF7F")
      (((class color) (background dark)) :foreground "#FFBF7F"))
    "Face used by Ivy for highlighting the arrow."
    :group 'ivy)
  ;;
  (defun my:ivy-format-function-arrow (cands)
    "Custom: Transform CANDS into a string for minibuffer."
    (setq-local tab-width 1)
    (ivy--format-function-generic
     (lambda (str)
       (concat " "
               (all-the-icons-faicon
                "hand-o-right" :face 'my:ivy-arrow-visible)
               "\t" (ivy--add-face str 'ivy-current-match)))
     (lambda (str)
       (concat ;; (all-the-icons-faicon "hand-o-right" :foreground 'background)
        "   \t" str))
     cands
     "\n"))
  ;; 長い表示を shrink -> advice override
  (defun my:ivy--insert-prompt ()
    "Custom."
    (when (setq ivy--prompt (ivy-prompt))
      (unless (memq this-command '(ivy-done
                                   ivy-alt-done
                                   ivy-partial-or-done
                                   counsel-find-symbol))
        (setq ivy--prompt-extra ""))
      (let (head tail)
        (if (string-match "\\(.*?\\)\\(:? ?\\)\\'" ivy--prompt)
            (progn
              (setq head (match-string 1 ivy--prompt))
              (setq tail (match-string 2 ivy--prompt)))
          (setq head ivy--prompt)
          (setq tail ""))
        (let ((inhibit-read-only t)
              (std-props
               '(front-sticky t rear-nonsticky t field t read-only t))
              (n-str
               (concat
                (if (and (bound-and-true-p minibuffer-depth-indicate-mode)
                         (> (minibuffer-depth) 1))
                    (format "[%d] " (minibuffer-depth))
                  "")
                (concat
                 (if (string-match "%d.*%d" ivy-count-format)
                     (format head
                             (1+ ivy--index)
                             (or (and (ivy-state-dynamic-collection ivy-last)
                                      ivy--full-length)
                                 ivy--length))
                   (format head
                           (or (and (ivy-state-dynamic-collection ivy-last)
                                    ivy--full-length)
                               ivy--length)))
                 ivy--prompt-extra
                 tail)))
              (d-str (if ivy--directory
                         ;; max で 45文字 + 末尾のファイル名
                         (my:shorten-file-path ivy--directory 45)
                       "")))
          (save-excursion
            (goto-char (point-min))
            (delete-region (point-min) (minibuffer-prompt-end))
            (let ((len-n (length n-str))
                  (len-d (length d-str))
                  (ww (window-width)))
              (setq n-str
                    (cond ((> (+ len-n len-d) ww)
                           (concat n-str "\n" d-str "\n"))
                          ((> (+ len-n len-d (length ivy-text)) ww)
                           (concat n-str d-str "\n"))
                          (t
                           (concat n-str d-str)))))
            (when ivy-pre-prompt-function
              (setq n-str (concat (funcall ivy-pre-prompt-function) n-str)))
            (when ivy-add-newline-after-prompt
              (setq n-str (concat n-str "\n")))
            (let ((regex (format "\\([^\n]\\{%d\\}\\)[^\n]" (window-width))))
              (while (string-match regex n-str)
                (setq n-str (replace-match
                             (concat (match-string 1 n-str) "\n")
                             nil t n-str 1))))
            (set-text-properties 0 (length n-str)
                                 `(face minibuffer-prompt ,@std-props)
                                 n-str)
            (setq n-str (funcall ivy-set-prompt-text-properties-function
                                 n-str std-props))
            (insert n-str))
          ;; Mark prompt as selected if the user moves there or it is the only
          ;; option left.  Since the user input stays put, we have to manually
          ;; remove the face as well.
          (when ivy--use-selectable-prompt
            (if (= ivy--index -1)
                (ivy-add-face-text-property
                 (minibuffer-prompt-end)
                 (line-end-position)
                 'ivy-prompt-match)
              (remove-list-of-text-properties
               (minibuffer-prompt-end) (line-end-position) '(face))))
          ;; get out of the prompt area
          (constrain-to-field nil (point-max))))))
  ;; リストアイコン表示
  (defun my:ivy-pre-prompt-function ()
    (format "%s "
            (all-the-icons-faicon "sort-amount-asc")))
  ;;
  :advice ((:override ivy--insert-prompt
                      my:ivy--insert-prompt))
  :custom
  ((ivy-use-virtual-buffers     . t)      ;; bookmark, recentf と結合
   (ivy-extra-directories       . nil)      ;; default は "." と ".."
   (ivy-fixed-height-minibuffer . t)
   (ivy-height                  . 9)
   (ivy-wrap                    . t)
   (ivy-count-format            . "[%d/%d] ")
   (ivy-pre-prompt-function     . 'my:ivy-pre-prompt-function)
   (ivy-format-functions-alist  . '((t . my:ivy-format-function-arrow)))
   ;; (ivy-re-builders-alist       . '((t . ivy--regex-fuzzy)))
   (ivy-use-selectable-prompt   . t)
   (ivy-read-action-function    . 'ivy-hydra-read-action)
   (ivy-initial-inputs-alist
    .
    '((counsel-minor . "^+")
      (counsel-package . "^+")
      (counsel-org-capture . "^")
      ;; (counsel-M-x . "^")
      (counsel-describe-function . "^")
      (counsel-describe-variable . "^")
      (org-refile . "^")
      (org-agenda-refile . "^")
      (org-capture-refile . "^")
      (Man-completion-table . "^")
      (woman . "^")))
   )
  :bind
  ((:ivy-minibuffer-map )
   ("<escape>" . minibuffer-keyboard-quit))
  :config
  ;; 何回層入ったかプロンプトに表示．
  (when (setq enable-recursive-minibuffers t)
    (minibuffer-depth-indicate-mode 1))
  )
   #+END_SRC
** =all-the-icons-ivy=: 候補のアイコン表示
   :PROPERTIES:
   :CUSTOM_ID: orgb77dc600
   :END:
   #+BEGIN_SRC emacs-lisp
(leaf all-the-icons-ivy
  :ensure t
  :after all-the-icons-in-terminal
  :config
  (all-the-icons-ivy-setup)
  )
   #+END_SRC
** =counsel=: ivy による既存コマンドの拡張 [/]
   :PROPERTIES:
   :CUSTOM_ID: org6cfb3ea9
   :END:
   recentf で表示されるリストを短縮する様にしてみた.
   飽きたら止めるかも.

   ついでに ido の時と同様に "C-f" で fallback して
   素の find-file に行って欲しいのでその設定を追加したり
   - [[https://github.com/abo-abo/swiper/issues/1333][Making minibuffer (editing) behaviour during counsel-find-file more like default find-file · Issue #1333 · abo-abo/swiper]]
   が元ネタ.
   #+BEGIN_SRC emacs-lisp
(leaf counsel
  :ensure t
  :after ivy
  :defvar (recentf-list
           counsel-find-file-ignore-regexp
           )
  :init
  (leaf s :ensure t :require t)
  ;;
  (defun my:counsel-find-file-fallback-command ()
    "Fallback to non-counsel version of current command."
    (interactive)
    (when (bound-and-true-p ivy-mode)
      (ivy-mode -1)
      (add-hook 'minibuffer-setup-hook
                'my:counsel-find-file-fallback-command--enable-ivy))
    (ivy-set-action
     (lambda (current-path)
       (let ((old-default-directory default-directory))
         (let ((i (length current-path)))
           (while (> i 0)
             (push (aref current-path (setq i (1- i))) unread-command-events)))
         (let ((default-directory "")) (call-interactively 'find-file))
         (setq default-directory old-default-directory))))
    (ivy-done))
  (defun my:counsel-find-file-fallback-command--enable-ivy ()
    (remove-hook 'minibuffer-setup-hook
                 'my:counsel-find-file-fallback-command--enable-ivy)
    (ivy-mode t))
  ;;
  (defun my:counsel-recentf ()
    "Custom: Find a file on `recentf-list' with shorten-file-path"
    (interactive)
    (require 'recentf nil 'noerror)
    (recentf-mode)
    (ivy-read "Recentf: " (mapcar (lambda (f)
                                    (cons (my:shorten-file-path f 70) f))
                                  recentf-list)
              :action (lambda (f)
                        (with-ivy-window
                          (find-file (cdr f))))
              :require-match t
              :caller 'counsel-recentf))
  ;;
  :bind (("C-x C-f" . counsel-find-file)
         ("C-x C-r" . my:counsel-recentf)
         ("M-x"     . counsel-M-x)
         (:counsel-find-file-map
          ("C-l"    . counsel-up-directory)
          ("C-f"    . my:counsel-find-file-fallback-command)
          ))
  :config
  ;; 無視する拡張子の追加
  (cl-loop for ext in
           '(;; TeX
             ".dvi"
             ".fdb_latexmk"
             ".fls"
             ".ilg"
             ".jqz"
             ".nav"
             ".out"
             ".snm"
             ".synctex\\.gz"
             ".vrb"
             ;; fortran >= 90
             ".mod"
             ;; zsh
             ".zwc"
             ;; libtool
             ".in"
             ".libs/"
             ;; fxxkin Apple
             ".DS_Store"
             "._DS_Store"
             )
           do
           (add-to-list 'completion-ignored-extensions ext))
  (setq counsel-find-file-ignore-regexp
        (format "\\%s\\'"
                (s-replace "/" "\\/"
                           (s-join "\\'\\|" completion-ignored-extensions))))
  )
   #+END_SRC
   - [ ] fzf, ag, ...
** =prescient=: 補完候補をより便利に.
   :PROPERTIES:
   :CUSTOM_ID: org7c0366ac
   :END:
   #+BEGIN_SRC emacs-lisp
(leaf ivy-prescient
  :ensure t
  :after counsel
  :custom
  `(;; (ivy-prescient-enable-filtering . t)
    (prescient-aggressive-file-save . t)
    (prescient-save-file
     . ,(expand-file-name "prescient-save.el" my:d:tmp))
    (prescient-filter-method . '(fuzzy regexp initialism))
    (ivy-prescient-retain-classic-highlighting . t))
  :config
  ;; (1) マイナーモードの有効化
  (ivy-prescient-mode 1)
  ;; (2) =counsel-M-x= をイニシャル入力対応にする
  ;; (setf (alist-get 'counsel-M-x ivy-re-builders-alist)
  ;;       #'ivy-prescient-re-builder)
  ;; (3) デフォルトのイニシャル入力を上書きする
  ;; (setf (alist-get t ivy-re-builders-alist) #'ivy--regex-ignore-order)
  )
   #+END_SRC
* Elscreen
  :PROPERTIES:
  :CUSTOM_ID: orgd9b46f9c
  :END:
** TODO 導入 [0/1]                                                   :Debian:
   :PROPERTIES:
   :CUSTOM_ID: orge28d4f35
   :END:
   emacs-jpのfolk版を利用中。
   modeline の表示そのものは無効化しておく．
   #+begin_src emacs-lisp
(leaf elscreen
  :el-get (elscreen
           :type github
           :pkgname "emacs-jp/elscreen")
  :custom
  ((elscreen-display-tab           . 8)
   (elscreen-tab-display-control   . nil)
   (elscreen-display-screen-number . nil)
   (elscreen-prefix-key            . "") ;; なんか嫌だなぁ...
   )
  :config
  (elscreen-start)
  )
   #+end_src
   - [ ] Debian パッケージ版は古い．更新すべき
** TODO elscreen + zsh での連携 [/]
   :PROPERTIES:
   :CUSTOM_ID: org1767ff1c
   :END:
   詳細は
   - [[https://masutaka.net/chalow/2011-09-28-1.html][ターミナルの zsh と Emacs を風のように駆け抜ける！]]
   - [[http://syohex.hatenablog.com/entry/20111026/1319606395][cdeを改良]]
   - [[https://qiita.com/__hage/items/2dd732b4dd68e124e8bd][cdeとelscreen-separate-buffer-listの相性が悪い]]
   などを参考に.
   #+begin_src emacs-lisp
(defun return-current-working-directory-to-shell ()
  (expand-file-name
   (with-current-buffer
       (if (featurep 'elscreen)
           (let* ((frame-confs (elscreen-get-frame-confs (selected-frame)))
                  (num (nth 1 (assoc 'screen-history frame-confs)))
                  (cur-window-conf
                   (assoc 'window-configuration
                          (assoc num (assoc 'screen-property frame-confs))))
                  (marker (nth 2 cur-window-conf)))
             (marker-buffer marker))
         (nth 1
              (assoc 'buffer-list
                     (nth 1 (nth 1 (current-frame-configuration))))))
     default-directory)))
   #+end_src
   - [ ] 最近動かない事があるのだが...
* 日本語入力: =ddskk=
  :PROPERTIES:
  :CUSTOM_ID: orgb83f65a0
  :END:
  [[http://openlab.ring.gr.jp/skk/ddskk-ja.html][Daredevil SKK (DDSKK)]] をメインで使用中．無いと途方に暮れる．
  ちなみにGTKが有効になっていると =gtk-immodule= なんかと衝突するので
  =~/.Xresources= で xim を無効にしておくと良い．
  例えば以下の様に:
  #+begin_src conf :tangle no
! disable XIM
Emacs*useXIM: false
  #+end_src
** Emacs 本体側の設定(ddskk)
   :PROPERTIES:
   :CUSTOM_ID: orgeaefbd62
   :END:
   実際の設定は別ファイルで行なわれるため
   ここでは設定ファイルの位置変更を変更している．
   #+begin_src emacs-lisp
(defvar skk-user-directory (concat my:d:tmp "skk"))
(unless (file-directory-p skk-user-directory)
  (make-directory skk-user-directory))
(unless (locate-library "skk")
  (package-install 'ddskk t))
(leaf skk
  :bind (("C-x j"   . skk-mode)
         ("C-x C-j" . skk-mode)
         ("C-\\"    . skk-mode))
  :init
  (setq skk-init-file (concat user-emacs-directory "init-ddskk")
        default-input-method "japanese-skk" )
  )
   #+end_src
** DDSKK 本体の設定
   :PROPERTIES:
   :CUSTOM_ID: org03d84f47
   :END:
*** 基本動作
    :PROPERTIES:
    :CUSTOM_ID: orgab495f21
    :END:
    byte-compile の為の読み込み
#+BEGIN_SRC emacs-lisp :tangle init-ddskk.el
(eval-when-compile (require 'skk))
#+END_SRC
    sticky shift: [[http://homepage1.nifty.com/blankspace/emacs/sticky.html][sticky shift]] を参照のこと.
    ddskk の 14.2 以降から同梱されるようになった(ありがたい)
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-sticky-key ";")
    #+end_src
    変換候補の表示位置
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-show-candidates-always-pop-to-buffer t)
    #+end_src
    候補表示件数を2列に
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-henkan-number-to-display-candidates 5)
    #+end_src
    日本語表示しない
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-japanese-message-and-error nil)
    #+end_src
    メニューを日本語にしない -> toolbar 非表示だし.
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-show-japanese-menu nil)
    #+end_src
    注釈の表示
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-show-annotation nil)
    #+end_src
    インジケータの表示のカスタマイズ
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-latin-mode-string "[_A]")
(setq skk-hiragana-mode-string "[あ]")
(setq skk-katakana-mode-string "[ア]")
(setq skk-jisx0208-latin-mode-string "[Ａ]")
(setq skk-jisx0201-mode-string "[_ｱ]")
(setq skk-abbrev-mode-string "[aA]")
(setq skk-indicator-use-cursor-color nil)
    #+end_src
    インジケータを左端に表示
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-status-indicator 'left)
    #+end_src
    mode-line が動くのが許せないので, ちょっと修正
    #+begin_src emacs-lisp :tangle init-ddskk.el
(defadvice skk-make-indicator-alist
    (after my:set-skk-default-indicator activate)
  (dolist (elem
           '((abbrev " [aA]" . "--[aA]:")
             (latin " [_A]" . "--[_A]:")
             (default " [--]" . "--[--]:")))
    (setq ad-return-value
          (append (cons elem nil)
                  (delq (assoc (car elem) ad-return-value) ad-return-value)))))
(setq skk-show-inline t)
    #+end_src
    カーソルには色をつけない
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-use-color-cursor nil)
    #+end_src
    キーバインド
    #+begin_src emacs-lisp :tangle init-ddskk.el
(global-set-key "\C-x\C-j" 'skk-mode)
(global-set-key "\C-xj" 'skk-mode)
(global-set-key "\C-j" 'skk-mode)
(global-set-key "\C-\\" 'skk-mode)
    #+end_src
    半角カナを入力
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-use-jisx0201-input-method t)
    #+end_src
    Enter で改行しない
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-egg-like-newline t)
    #+end_src
    "「"を入力したら"」"も自動で挿入
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-auto-insert-paren t)
    #+end_src
    句読点変換ルール
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-kuten-touten-alist
      '(
        (jp    . ("。" . "、"))
        (jp-en . ("。" . ", "))
        (en-jp . ("．" . "，"))
        (en    . (". " . ", "))
        ))
(setq-default skk-kutouten-type 'en)
    #+end_src
    全角記号の変換: @ での日付入力は使わない
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-rom-kana-rule-list
      (append skk-rom-kana-rule-list
              '(("!" nil "!")
                (":" nil ":")
                (";" nil ";")
                ("?" nil "?")
                ("z " nil "　")
                ("\\" nil "\\")
                ("@" nil "@")
                )))
    #+end_src
    送り仮名が厳密に正しい候補を優先
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-henkan-strict-okuri-precedence t)
    #+end_src
    辞書の共有
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-share-private-jisyo t)
    #+end_src
    変換候補を縦に表示
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-show-inline 'vertical)
    #+end_src
*** 辞書の設定
    :PROPERTIES:
    :CUSTOM_ID: orgb6cec722
    :END:
    追加している辞書の一覧は
    - [[http://www.chibutsu.org/jisho/][地球物理辞書]]
    - [[http://www.geocities.jp/living_with_plasma/tanudic.html][天文・天体物理用語の漢字変換用辞書]]
    - はてなキーワード
    - [[http://matsucon.net/material/dic/][2ちゃんねる顔文字辞書 MatsuCon]]
    - [[http://matsucon.net/][MatsuCon]]
    といった所.
    はてなキーワードからの辞書の抽出は [[http://d.hatena.ne.jp/znz][znz]] さんの
    - [[http://rubyist.g.hatena.ne.jp/znz/20060924/p1][「はてなダイアリーキーワードふりがなリスト」を SKK の辞書に変換]]
    を参考に.
    [[http://matsucon.net/][MatsuCon]] で公開されている顔文字に関しては
    顔文字に ; や が含まれている場合に, 適宜quoteする必要があるので
    以下のスクリプトで適当に変換.
    #+begin_src ruby :tangle no
#!/usr/bin/env ruby
require 'nkf'
src = ARGV[0]
if ARGV.size < 1
  puts "usage: ime2skk.rb ime_dictionary"
  exit 0
end
File.open(src, "r") {|f|
  f.each do |line|
    line_euc = NKF.nkf("-S -e",line)
    if line_euc =~ /^([^!]+?)\t(.+?)\t.+$/
      entry = $1
      content = $2
      if content =~/;/
        puts entry + " /(concat \"" + content.gsub(';','\\\\073') + "\")/"
      elsif content =~/\//
        puts entry + " /(concat \"" + content.gsub('/','\\\\057') + "\")/"
      else
        puts entry + " /" + content + "/"
      end
    end
  end
}
    #+end_src
    他にも quote する必要あるような気もするけれど, それは気がついた時に.

    辞書サーバがそもそも UTF-8 を扱えれば良いのだけれども.
    辞書サーバの指定は以下.
    #+begin_src emacs-lisp :tangle init-ddskk.el
(cond
 ((getenv "SKKSERVER")
  (setq skk-server-host "127.0.0.1"
        skk-server-portnum "1178"
        skk-large-jisyo nil)
  (add-to-list 'skk-search-prog-list
               '(skk-server-completion-search) t)
  (add-to-list 'skk-search-prog-list
               '(skk-comp-by-server-completion) t))
 (t
  (setq skk-get-jisyo-directory (concat my:d:tmp "skk-jisyo")
        skk-large-jisyo (concat skk-get-jisyo-directory "/SKK-JISYO.L")))
 )
(when (file-exists-p "/usr/local/share/skkdic/SKK-JISYO.emoji.utf8")
  (setq skk-extra-jisyo-file-list
        (list '("/usr/local/share/skkdic/SKK-JISYO.emoji.utf8" . utf-8))))
    #+end_src
    辞書登録の際に送り仮名を削除
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-check-okurigana-on-touroku 'auto)
    #+end_src
    漢字登録のミスをチェックする
    #+begin_src emacs-lisp :tangle init-ddskk.el
(setq skk-check-okurigana-on-touroku t)
    #+end_src
*** インクリメンタルサーチ
    :PROPERTIES:
    :CUSTOM_ID: org0cbdad2e
    :END:
    minibuffer 内では強制的に skk off.
    インクリメンタルサーチは migemo に任せることに．
    #+begin_src emacs-lisp :tangle init-ddskk.el
(add-hook 'skk-mode-hook
          (lambda ()
            (and (skk-in-minibuffer-p)
                 (skk-mode-exit))))
(setq skk-isearch-start-mode 'latin)
    #+end_src
* 校正, 辞書等
  :PROPERTIES:
  :CUSTOM_ID: org15a06190
  :END:
** SOMEDAY =redpen-paragraph=: [[http://redpen.cc/][redpen]] による文章校正 [/]
   :PROPERTIES:
   :CUSTOM_ID: orgc780f35e
   :END:
   #+BEGIN_SRC emacs-lisp
(leaf redpen-paragraph
  :disabled t
  :if (and (executable-find "redpen")
           (file-directory-p "~/.config/redpen"))
  :ensure t
  :bind
  (("C-c C-r" . redpen-paragraph))
  :hook
  ((LaTeX-mode-hook . (lambda ()
                        (setq redpen-commands
                              '(
                                ;; for english command
                                "redpen -r json2 -c ~/.config/redpen/redpen-conf-en.xml -f latex %s 2>/dev/null"
                                ;; for japanese command
                                "redpen -r json2 -c ~/.config/redpen/redpen-conf-ja.xml -f latex %s 2>/dev/null"
                                )))
                        ))
  :config
  ;; default
  (setq redpen-commands
    '(
      ;; for english command
      "redpen -r json2 -c ~/.config/redpen/redpen-conf-en.xml %s 2>/dev/null"
      ;; for japanese command
      "redpen -r json2 -c ~/.config/redpen/redpen-conf-ja.xml %s 2>/dev/null"
      )
    redpen-paragraph-force-reading-whole t)
  )
   #+END_SRC
   - [ ] うまく動いていない. 一旦保留
** =ispell=: spell checker
   :PROPERTIES:
   :CUSTOM_ID: org3737a28e
   :END:
   ispell はコマンドとして =aspell= を利用する.
   #+BEGIN_SRC emacs-lisp
(leaf ispell
  :if (file-executable-p "aspell")
  :custom
  (ispell-program-name . "aspell")
  :config
  (add-to-list 'ispell-skip-region-alist '("[^\000-\377]+"))
  )
   #+END_SRC
** =flyspell=: on-the-fly spell checker [0/1]
   :PROPERTIES:
   :CUSTOM_ID: org820e6b6d
   :END:
   flyspell-mode は別途有効化しておいた方が良いのかもしれない
   #+BEGIN_SRC emacs-lisp
(leaf flyspell
  :ensure t
  :diminish "F"
  :defun
  flyspell-emacs-popup-textual
  :preface
  (defun my:flyspell-popup-choose (orig event poss word)
    (if (window-system)
        (funcall orig event poss word)
      (flyspell-emacs-popup-textual event poss word)))
  :advice (:around flyspell-emacs-popup
                   my:flyspell-popup-choose)
  :hook
  ;; flyspell-prog-mode との switch が欲しい
  ((LaTeX-mode-hook . flyspell-mode))
  )
   #+END_SRC
   - [ ] flyspell-prog-mode との switch が欲しい
** =lookup=: 電子辞書の検索
   :PROPERTIES:
   :CUSTOM_ID: org3002f57f
   :END:
   EPWING化した辞書群を検索するために =lookup-el= ver. 1.4 系列を利用
   #+BEGIN_SRC emacs-lisp
(leaf lookup
  :if (and (my:dpkg-status "lookup-el")
           (file-exists-p "/usr/local/share/dict/lookup-enabled"))
  :commands (lookup lookup-region lookup-pattern)
  :bind (("C-c w" . lookup-pattern)
         ("C-c W" . lookup-word))
  :custom
  (lookup-search-agents
   . '((ndeb "/usr/local/share/dict/eijiro" :alias "英辞郎")
       (ndeb "/usr/local/share/dict/waeijiro" :alias "和英辞郎")
       (ndeb "/usr/local/share/dict/rikagaku5" :alias "理化学辞典 第5版")
       (ndeb "/usr/local/share/dict/koujien4" :alias "広辞苑 第4版")
       (ndeb "/usr/local/share/dict/wadai5" :alias "研究社 和英大辞典 第5版")
       (ndeb "/usr/local/share/dict/eidai6" :alias "研究社 英和大辞典 第6版")
       (ndeb "/usr/local/share/dict/colloc" :alias "研究社 英和活用大辞典 ")))
  )
   #+END_SRC
* Copy & Paste:
  :PROPERTIES:
  :CUSTOM_ID: org12fd2b4e
  :END:
** Linux では =xclip= を利用
   :PROPERTIES:
   :CUSTOM_ID: org1689d1f5
   :END:
   clipboard と PRIMARY の同期には =gpaste= を使っている．
   #+begin_src emacs-lisp
(leaf xclip
  :if (and (executable-find "xclip")
           (eq system-type 'gnu/linux))
  :ensure t
  :config
  (xclip-mode 1))
   #+end_src
** macOS では =pbcopy/pbpaste= を利用.
   :PROPERTIES:
   :CUSTOM_ID: orgb2de5472
   :END:
   =pbcopy/pbpase= の呼び出し方が変わった? 動かない時がある様な。
   #+BEGIN_SRC emacs-lisp
(leaf *macOSclipborad
  :if (eq system-type 'darwin)
  :preface
  (defun my:copy-from-osx ()
    "Get string via pbpaste"
    (shell-command-to-string "pbpaste"))
  (defun my:paste-to-osx (text &optional push)
    "put `TEXT' via pbcopy with `PUSH' mode"
    (let ((process-connection-type nil))
      (let ((proc (start-process "pbcopy" "*Messages*" "pbcopy")))
        (process-send-string proc text)
        (process-send-eof proc))))
  :config
  (setq interprogram-cut-function   'my:paste-to-osx
        interprogram-paste-function 'my:copy-from-osx)
  )
   #+END_SRC
* =ibuffer=: buffer の操作
  :PROPERTIES:
  :CUSTOM_ID: org5f756509
  :END:
  buffer を眺めるのは ibuffer が好み
  #+begin_src emacs-lisp
(leaf ibuffer
  :after all-the-icons-in-terminal
  :defun (ibuffer-current-buffer)
  :defvar (ibuffer-formats)
  :preface
  (defun my:ibuffer-find-file ()
    "Like `find-file', but default to the directory of the buffer at point."
    (interactive)
    (let ((default-directory
            (let ((buf (ibuffer-current-buffer)))
              (if (buffer-live-p buf)
                  (with-current-buffer buf
                    default-directory)
                default-directory))))
      (find-file default-directory)))
  ;;
  :bind (("C-x C-b" . ibuffer-other-window)
         ("C-x b"   . ibuffer-other-window)
         ("C-x M-b" . ibuffer)
         (:ibuffer-mode-map
          ("C-x C-f" . my:ibuffer-find-file))
         )
  :config
  (define-ibuffer-column icon (:name "  ")
    (let ((icon
           (if (and (buffer-file-name)
                    (all-the-icons-auto-mode-match?))
               (all-the-icons-icon-for-file
                (file-name-nondirectory (buffer-file-name)))
             (all-the-icons-icon-for-mode major-mode ))))
      (if (symbolp icon)
          (setq icon
                (all-the-icons-faicon
                 "file-o"
                 :face 'all-the-icons-dsilver))
        icon)))
  ;;
  (setq ibuffer-formats
        `((mark modified read-only
                " " (icon 2 2 :left :elide)
                ,(propertize " " 'display `(space :align-to 8))
                (name 18 18 :left :elide)
                " " (size 9 -1 :right)
                " " (mode 16 16 :left :elide) " " filename-and-process)
          (mark " " (name 16 -1) " " filename)))
  )
  #+end_src
* =wanderulst=: MUA の設定
  :PROPERTIES:
  :CUSTOM_ID: org2c2abb9b
  :END:
  MUA として Wanderlust を使っている
** Emacs 本体側の設定(wanderlust)
   :PROPERTIES:
   :CUSTOM_ID: org47a9ca66
   :END:
   Emacs 本体での設定は以下の通り. Wanderlust 自体の設定は別ファイルで行なわれる．
   ここでは =wl-init-file= を指定することで, 設定ファイルを明示している．
   #+begin_src emacs-lisp
(leaf wl
  :if (and (or (my:dpkg-status "wl")
               (my:dpkg-status "wl-beta"))
           (my:dpkg-status "rail"))
  :commands (wl wl-other-frame wl-draft wl-user-agent wl-user-agent-compose wl-draft-send wl-draft-kill)
  :preface
  (defun my:wl-mode-line-buffer-identification (&optional id)
    (force-mode-line-update t))
  :advice (:override wl-mode-line-buffer-identification
                     my:wl-mode-line-buffer-identification)
  :init
  (define-mail-user-agent
    'wl-user-agent
    'wl-user-agent-compose
    'wl-draft-send
    'wl-draft-kill
    'mail-send-hook)
  (setq elmo-msgdb-directory "~/.cache/wanderlust"
        elmo-maildir-folder-path "~/.cache/wanderlust"
        elmo-cache-directory "~/.cache/wanderlust"
        wl-score-files-directory "~/.cache/wanderlust"
        wl-init-file (concat user-emacs-directory "init-wl")
        mail-user-agent 'wl-user-agent
        read-mail-command 'wl)
  (unless (file-directory-p elmo-msgdb-directory)
    (make-directory elmo-msgdb-directory))
  (unless (file-directory-p (concat elmo-msgdb-directory "/local"))
    (make-directory (concat elmo-msgdb-directory "/local")))
  (unless (file-directory-p (concat elmo-msgdb-directory "/local/Trash"))
    (make-directory (concat elmo-msgdb-directory "/local/Trash")))
  :config
  )
   #+end_src
   割と =/etc/emacs/site-start.d/65wl-beta.el= と重複している気がするが...
** Wanderlust 本体の設定
   :PROPERTIES:
   :CUSTOM_ID: org160184bf
   :END:
   実際の設定は以下の通り
*** byte-compile の準備
    :PROPERTIES:
    :CUSTOM_ID: orge2af69a1
    :END:
     #+begin_src emacs-lisp :tangle init-wl.el
(eval-and-compile
  (leaf el-x
    :el-get (el-x
             :type github
             :pkgname "sigma/el-x"
             :build `(("make" ,(format "EMACSBIN=%s" el-get-emacs)))
             :load-path "lisp"
             )
    :require t
    )
  )
(eval-when-compile
  (require 'cp5022x)
  (require 'wl)
  (require 'mime-def))
     #+end_src
*** 依存/追加ライブラリのインストールと読み込み
    :PROPERTIES:
    :CUSTOM_ID: org9638e017
    :END:
**** rail
     :PROPERTIES:
     :CUSTOM_ID: org587385af
     :END:
     SEMI や FLIM などの UA の表示に [[http://uwabami.github.com/rail/][rail]] を使っている.
     ちなみに rail を有効にすると, 以下の様に User-Agent が表示される
     #+html: <div class="col-7 px2 mx-auto">
     #+html: <amp-img layout="responsive" width=640 height=400 src="https://uwabami.github.io/software/rail/images/wanderlust_with_or_without_rail.png" alt="rail preview"></amp-img>
     #+html: </div>

     #+begin_src emacs-lisp :tangle init-wl.el
(leaf rail
  :init
  (setq rail-emulate-genjis t)
  :require t
  )
     #+end_src
**** cp5022x を使う
     :PROPERTIES:
     :CUSTOM_ID: orga4113e25
     :END:
     ISO-2022-JP を CP50220 として扱う.
     [[http://d.hatena.ne.jp/kiwanami/20091103/1257243524][Wanderlustと文字コード]] も参照のこと.
     #+begin_src emacs-lisp :tangle init-wl.el
(add-to-list 'mime-charset-coding-system-alist
             '(iso-2022-jp . cp50220))
;; fxxkin outlook
(add-to-list 'mime-charset-coding-system-alist
             '(gb2312 . gbk))
;;
(setq wl-mime-charset 'iso-2022-jp)
     #+end_src
**** elscreen-wl
     :PROPERTIES:
     :CUSTOM_ID: orgdbee6f4a
     :END:
     メール作成時に =elscreen= と連携してくれる．
     apel 依存を外した fork 版を使う
     #+begin_src emacs-lisp :tangle init-wl.el
(leaf elscreen-wl
  :el-get (elscreen-wl
           :type github
           :pkgname "syohex/emacs-elscreen-wl")
  )
     #+end_src
**** SEMI の追加設定
     :PROPERTIES:
     :CUSTOM_ID: orgc4ec7a62
     :END:
     HTML メールを表示するために eww を使う.
     mime-setup がロードされる前に記述する必要あり.
     #+begin_src emacs-lisp :tangle init-wl.el
(leaf mime-setup
  :preface
  (setq mime-view-text/html-previewer 'shr
        mime-setup-enable-inline-html 'shr)
  (defvar my:shr-width 72)
  ;;
  (defun my:shr-insert-document (&rest them)
    (let ((shr-width my:shr-width)) (apply them)))
  ;;
  (defun my:mime-shr-preview-text/html (&rest args)
    (advice-add 'shr-insert-document :around 'my:shr-insert-document)
    (unwind-protect
        (apply args)
      (advice-remove 'shr-insert-document 'my:shr-insert-document)))
  ;;
  (advice-add 'mime-shr-preview-text/html :around
              'my:mime-shr-preview-text/html)
  ;;
  :config
  (with-eval-after-load 'shr
    (setq shr-use-colors nil
          shr-use-fonts nil
          shr-width 72))
  )
     #+end_src
     どのアプリケーションで開くか → =xdg-open= に丸投げ．
     #+begin_src emacs-lisp :tangle init-wl.el
;; (setq mime-view-mailcap-files '("~/.mailcap"))
     #+end_src
     =~/.mailcap= 自体は以下
     #+begin_src conf :tangle no
applications/*; xdg-open %s;
image/*; xdg-open %s;
video/*; xdg-open %s;
     #+end_src
     MIME の例の保存先の変更
     #+begin_src emacs-lisp :tangle init-wl.el
(setq mime-situation-examples-file
      (concat my:d:tmp "mime-example"))
     #+end_src
     text/plain を html より優先
     #+begin_src emacs-lisp :tangle init-wl.el
(setq mime-view-type-subtype-score-alist
      '(((text . plain) . 1)
        ((text . html)  . 0)
        ))
     #+end_src
     音を鳴らすアレやコレの無効化
     #+begin_src emacs-lisp :tangle init-wl.el
(setq mime-play-find-every-situations nil
      mime-play-delete-file-immediately nil
      process-connection-type nil)
     #+end_src
*** 個人情報の設定
    :PROPERTIES:
    :CUSTOM_ID: org6dae78eb
    :END:
    具体的な設定内容は以下のファイルに置いている
    #+begin_src emacs-lisp :tangle init-wl.el
(load (concat my:d:password-store "/wl-info.gpg"))
    #+end_src
    設定している内容は以下の通り
**** 自身のメールアドレスと購読メーリングリストの設定
     :PROPERTIES:
     :CUSTOM_ID: org7f87384b
     :END:
     #+begin_src emacs-lisp :tangle no
;; From: の設定
(setq wl-from (concat user-full-name " <" user-mail-address ">"))
;; (system-name) が FQDN を返さない場合、
;; `wl-local-domain' にホスト名を除いたドメイン名を設定
(setq wl-local-domain "example.com")
;; 自分のメールアドレスのリスト
(setq wl-user-mail-address-list
      (list (wl-address-header-extract-address wl-from)
            ;; "e-mail2@example.com"
            ;; "e-mail3@example.net" ...
            ))
;; 自分の参加しているメーリングリストのリスト
(setq wl-subscribed-mailing-list
      '("wl@lists.airs.net"
        "apel-ja@m17n.org"
        "emacs-mime-ja@m17n.org"
        ;; "ml@example.com" ...
        ))
     #+end_src
**** 送受信用サーバの設定
     :PROPERTIES:
     :CUSTOM_ID: orgba8bc2e7
     :END:
     受信(IMAP)
     #+begin_src emacs-lisp :tangle no
(setq elmo-imap4-default-server "your imap server")
(setq elmo-imap4-default-port '993)
(setq elmo-imap4-default-stream-type 'ssl)
     #+end_src
     送信(SMTP)
     #+begin_src emacs-lisp :tangle no
(setq wl-smtp-posting-server "your smtp server")
(setq wl-smtp-posting-user "your account")
(setq wl-smtp-posting-port 587)
(setq wl-smtp-connection-type 'starttls)
(setq wl-smtp-authenticate-type "login")
     #+end_src
**** From に応じて送信サーバをきりかえる.
     :PROPERTIES:
     :CUSTOM_ID: org9af3a565
     :END:
     本来はメール作成時/返信時の template の切り替えなのだれど,
     送信時の SMTP の設定を from に合わせてきりかえるようにする.
     default に二重に指定しているのは,
     一度別のアカウントに切り替えた後に再びトグルして戻って来た際に元に戻す(上書き)するため.
     #+begin_src emacs-lisp :tangle no
(setq wl-template-alist
      '(("default"
         ("From" . wl-from)
         (wl-smtp-posting-server . "your smtp server")
         (wl-smtp-posting-user . "your account")
         (wl-smtp-posting-port . 587)
         (wl-smtp-connection-type . 'starttls)
         (wl-smtp-authenticate-type . "login")
         )
        ("example1"
         ("From" . "Your Name <account@example1.com>")
         (wl-smtp-posting-server . "smtp.example1.com")
         (wl-smtp-posting-user . "your account")
         (wl-smtp-posting-port . 587)
         (wl-smtp-connection-type . 'starttls)
         (wl-smtp-authenticate-type . "login")
         )
        ("example2"
         ("From" . "Your Name <account@example2.com>")
         (wl-smtp-posting-server . "smtp.example2.com")
         (wl-smtp-posting-user . "your account")
         (wl-smtp-posting-port . 587)
         (wl-smtp-connection-type . 'starttls)
         (wl-smtp-authenticate-type . "plain")
         )
        ("ssh:smtp"
         ;; need ssh tunnel
         ;; ssh -f -N -L 20025:localhost:25 smtp.server.com
         ("From" . "Your Name <account@example3.com>")
         (wl-smtp-posting-server . "localhost")
         (wl-smtp-posting-user . "your ssh account")
         (wl-smtp-posting-port . 20025)
         (wl-smtp-connection-type . 'nil)
         (wl-smtp-authenticate-type . 'nil)
         )
        ))
     #+end_src
     ssh tunnel を自動的にやる事はできないモンだろうか
     (送信時に open して, 送信後に close する, みたいなの).

     ついでに template の切り替えに関して幾つか設定.
     #+begin_src emacs-lisp :tangle init-wl.el
;; template 切り替え時に 内容を表示
(setq wl-template-visible-select t)
     #+end_src
     =draft-mode= で =C-c C-n= をするとテンプレートを切り替え
     #+begin_src emacs-lisp  :tangle init-wl.el
(define-key wl-draft-mode-map "\C-c\C-n" 'wl-template-select)
     #+end_src
     from に応じて wl-from, wl-envelope-from,
     送信 smtp サーバを変更する送信時に変更
     #+begin_src emacs-lisp  :tangle init-wl.el
(add-hook 'wl-draft-send-hook
          (lambda ()
            (set (make-local-variable 'wl-from)
                 (std11-fetch-field "From"))))
     #+end_src
     送信時に自動的に wl-draft-config-alist を適用...しない?
     #+begin_src emacs-lisp  :tangle init-wl.el
(remove-hook 'wl-draft-send-hook 'wl-draft-config-exec)
     #+end_src
*** 基本設定
    :PROPERTIES:
    :CUSTOM_ID: org19ec5248
    :END:
**** imap 関連
     :PROPERTIES:
     :CUSTOM_ID: org69cc3854
     :END:
     デフォルトの認証設定
     フォルダ名は UTF-7 でエンコードされているので,
     表示する際にこれをデコードする
     #+begin_src emacs-lisp :tangle init-wl.el
(setq elmo-imap4-use-modified-utf7 t)
     #+end_src
**** 非同期チェック
     :PROPERTIES:
     :CUSTOM_ID: org2d8166ce
     :END:
     #+begin_src emacs-lisp :tangle init-wl.el
(setq wl-folder-check-async t)
     #+end_src
**** フォルダの位置の default からの変更
     :PROPERTIES:
     :CUSTOM_ID: org6572a382
     :END:
     =~/.cache/wanderlust/= に集約している
     local の Mail folder の位置
     #+begin_src emacs-lisp :tangle init-wl.el
(setq elmo-maildir-folder-path "~/.cache/wanderlust"
      elmo-localdir-folder-path "~/.cache/wanderlust/local")
     #+end_src
     local フォルダの設定:
     =.lost+found= は =elmo-maildir-folder-path= からの相対パスになっていることに注意
     #+begin_src emacs-lisp :tangle init-wl.el
(setq elmo-lost+found-folder ".lost+found")
(setq wl-queue-folder "+queue")
     #+end_src
     folders の位置の変更
     #+begin_src emacs-lisp :tangle init-wl.el
(setq wl-folders-file (concat my:d:password-store "/wl-folders.gpg"))
     #+end_src
     Drafts, Trash の置き場所
     #+begin_src emacs-lisp :tangle init-wl.el
(setq wl-draft-folder "+Drafts")
(setq wl-trash-folder "+Trash")
(setq elmo-lost+found-folder "+lost+found")
(setq wl-temporary-file-directory "~/Downloads/")
     #+end_src
     アドレス帳
     #+begin_src emacs-lisp :tangle init-wl.el
(setq wl-use-petname t)
(setq wl-address-file  "~/.mua/Address")
     #+end_src
     LDAP サーバからアドレスを引くことも可能.
     以前は GCALDaemon を使って local に ldap サーバを上げていたのだけれども,
     Google Contacts の API が変わったらしく
     GCALDaemon で LDAP サーバは使えなくなったのでコメントアウト.
     #+begin_src emacs-lisp :tangle no
(setq wl-use-ldap t)
(setq wl-ldap-server "localhost")
(setq wl-ldap-port "389")
(setq wl-ldap-base "dc=math,dc=kyoto-u,dc=ac,dc=jp")
     #+end_src
     パスワードの保存先
     #+begin_src emacs-lisp :tangle init-wl.el
(setq elmo-passwd-alist-file-name (concat my:d:password-store "/wl-passwd.gpg"))
     #+end_src
**** フォルダ編集時に backup を作成しない.
     :PROPERTIES:
     :CUSTOM_ID: org72bfee4a
     :END:
     #+begin_src emacs-lisp :tangle init-wl.el
(setq wl-fldmgr-make-backup nil)
     #+end_src
**** FCC, BCC の設定
     :PROPERTIES:
     :CUSTOM_ID: org223d5fa2
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-fcc nil)
;; (setq wl-fcc "%Sent")
     #+end_src
     fcc を既読にする場合は以下．=wl-fcc= が nil の場合には意味は無い
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-fcc-force-as-read t)
     #+end_src
     bcc は常に自身に.
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-bcc (concat user-mail-address))
     #+end_src
**** 起動時に =%INBOX= のみをチェック
     :PROPERTIES:
     :CUSTOM_ID: org4378f104
     :END:
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-auto-check-folder-name "%INBOX")
     #+end_src
**** フォルダ選択時の初期設定
     :PROPERTIES:
     :CUSTOM_ID: org6efc7670
     :END:
     imap の namespace を毎度入力するのが面倒なので, これを追加しておく.
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-default-spec "%")
     #+end_src
**** confirm 関連の設定
     :PROPERTIES:
     :CUSTOM_ID: orgb2cf2b53
     :END:
     スキャン時の問い合わせの無効化.
     ちなみに confirm を nil にしても 問い合わせが無いだけで
     threshold は効くので, 明示的に nil に.
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq elmo-folder-update-confirm nil)
(setq elmo-folder-update-threshold nil)
(setq elmo-message-fetch-confirm nil)
(setq elmo-message-fetch-threshold nil)
(setq wl-prefetch-confirm nil)
(setq wl-prefetch-threshold nil)
     #+end_src
     終了時に確認しない
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-interactive-exit nil)
     #+end_src
     送信時は確認する
     #+begin_src emacs-lisp :tangle init-wl.el
(setq wl-interactive-send t)
     #+end_src
**** misc.
     :PROPERTIES:
     :CUSTOM_ID: org14b77860
     :END:
     大きいメッセージを送信時に分割しない
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq mime-edit-split-message nil)
     #+end_src
     スレッドは常に閉じる
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-thread-insert-opened nil)
     #+end_src
     3 pain 表示 -> 使わない
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-stay-folder-window nil)
     #+end_src
     未読を優先的に読む
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-summary-move-order 'unread)
     #+end_src
     改ページ無視
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-break-pages nil)
     #+end_src
     icon を使わない → GUI でもメニュー表示してないし, 体感的には遅くなる
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-highlight-folder-with-icon nil)
     #+end_src
**** dispose, delete の設定
     :PROPERTIES:
     :CUSTOM_ID: org83490625
     :END:
     Gmail用に%INBOXでは削除を =wl-trash-folder= への移動ではなく, 「delete」に．
     #+begin_src emacs-lisp   :tangle init-wl.el
(add-to-list 'wl-dispose-folder-alist
             '("^%INBOX" . remove))
     #+end_src
     迷惑メール関連も
     #+begin_src emacs-lisp   :tangle init-wl.el
(add-to-list 'wl-dispose-folder-alist
             '(".*Junk$" . remove))
     #+end_src
**** 折り返しの設定
     :PROPERTIES:
     :CUSTOM_ID: orgd88be525
     :END:
     message は折り返す.
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-message-truncate-lines nil)
     #+end_src
     draft も折り返す
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-draft-truncate-lines nil)
     #+end_src
**** mode-line の設定
     :PROPERTIES:
     :CUSTOM_ID: orgb31f5f2c
     :END:
     長いと嫌なのでイロイロ削る
     #+begin_src emacs-lisp   :tangle init-wl.el
(setq wl-summary-mode-line-format "") ; "%f {%t}(%n/%u/%a)"
(setq wl-message-mode-line-format "") ; "<< %f:%F>> [%m]"
     #+end_src
*** キーバインド関連
    :PROPERTIES:
    :CUSTOM_ID: org51dfe1e0
    :END:
    =C-c C-j= を browse-url に明け渡す
    #+begin_src emacs-lisp :tangle init-wl.el
(define-key wl-draft-mode-map "\C-c\C-j" 'browse-url-at-point)
    #+end_src
    =M-u= で unread にする
    #+begin_src emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "\M-u" 'wl-summary-mark-as-unread)
    #+end_src
    =i= で sync <- Mew 風
    #+begin_src emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "i" 'wl-summary-sync-update)
    #+end_src
    =C-o= は elscreen で使う
    #+begin_src emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "\C-o" nil )
    #+end_src
    =M-o= で =auto-refile=  (Mew 風)
    #+begin_src emacs-lisp :tangle init-wl.el
(define-key wl-summary-mode-map "\M-o" 'wl-summary-auto-refile)
    #+end_src
*** flag とフォルダを行き来する関数の追加
    :PROPERTIES:
    :CUSTOM_ID: org460a927d
    :END:
    "=" でフラグ付きフォルダと
    実際にメッセージのあるフォルダを行き来する.
    Gmail の「スター付き」フォルダでも有効
    #+begin_src emacs-lisp :tangle init-wl.el
(require 'elmo nil 'noerror)
(defun my:wl-summary-jump-to-referer-message ()
  (interactive)
  (when (wl-summary-message-number)
    (if (eq (elmo-folder-type-internal wl-summary-buffer-elmo-folder) 'flag)
        (progn
          (let* ((referer (elmo-flag-folder-referrer
                           wl-summary-buffer-elmo-folder
                           (wl-summary-message-number)))
                 (folder (if (> (length referer) 1)
                             (completing-read
                              (format "Jump to (%s): " (car (car referer)))
                              referer
                              nil t nil nil (car (car referer)))
                           (car (car referer)))))
            (wl-summary-goto-folder-subr folder 'no-sync nil nil t)
            (wl-summary-jump-to-msg (cdr (assoc folder referer)))))
      (when (eq (elmo-folder-type wl-summary-last-visited-folder) 'internal)
        (wl-summary-goto-last-visited-folder)))))
(define-key wl-summary-mode-map "=" 'my:wl-summary-jump-to-referer-message)
    #+end_src
*** summary-mode の表示のカスタマイズ
    :PROPERTIES:
    :CUSTOM_ID: org433d7a5c
    :END:
**** 自分が差出人である mail は To:某 と表示
     :PROPERTIES:
     :CUSTOM_ID: org63a385a5
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-summary-showto-folder-regexp ".*")
(setq wl-summary-from-function 'wl-summary-default-from)
     #+end_src
**** サマリ行の表示関連
     :PROPERTIES:
     :CUSTOM_ID: org94145d9c
     :END:
     サマリ行のフォーマット指定
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-summary-line-format
      "%T%P%1@%1>%Y/%M/%D %21(%t%[%19(%c %f%)%]%) %#%~%s"
      wl-summary-width (- (window-width) 1))
     #+end_src
     サマリ表示は切り詰めない
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-subject-length-limit t)
     #+end_src
     スレッドの幅の指定
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-thread-indent-level 2)
(setq wl-thread-have-younger-brother-str "+" ;; "├"
      wl-thread-youngest-child-str "+" ;; "└"
      wl-thread-vertical-str "|" ;; "│"
      wl-thread-horizontal-str "-" ;; "─"
      wl-thread-space-str " ")
     #+end_src
     以下の二つの設定を有効にするには
     =elmo-msgdb-extra-fields= を設定する必要がある.
     この変数は振り分け判定にも使用するのでそこで設定している
**** Gmail 風に, 自分宛のメールに ">" をつけて表示する
     :PROPERTIES:
     :CUSTOM_ID: orga083aeb5
     :END:
     元ネタ [[http://d.hatena.ne.jp/khiker/20080206/wanderlust]]
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-user-mail-address-regexp "^uwabami.*\\|^sasakyh.*")
;; 一覧表示での置き換え規則に追加
(defun my:wl-summary-line-for-me ()
  (if (catch 'found
        (let ((to (elmo-message-entity-field wl-message-entity 'to))
              (cc (elmo-message-entity-field wl-message-entity 'cc)))
          (when (or (stringp to) cc)
            (setq to
                  (append (if (stringp to) (list to) to)
                          (when cc
                            (if (stringp cc) (list cc) cc)))))
          (dolist (i to)
            (when (wl-address-user-mail-address-p (eword-decode-string i))
              (throw 'found t)))))
      ">"
    ""))
;; > を summary-line-format に追加
(setq wl-summary-line-format-spec-alist
      (append wl-summary-line-format-spec-alist
              '((?> (my:wl-summary-line-for-me)))))
     #+end_src
**** 添付ファイルがあったら, サマリ行に @ を付ける
     :PROPERTIES:
     :CUSTOM_ID: org04b0fd69
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-summary-line-format-spec-alist
      (append wl-summary-line-format-spec-alist
              '((?@ (wl-summary-line-attached)))))
     #+end_src
**** クォートされた文字列もデコードする
     :PROPERTIES:
     :CUSTOM_ID: org9b1eb3e9
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq mime-header-lexical-analyzer
      '(
        ;; eword-analyze-quoted-string
        eword-analyze-domain-literal
        eword-analyze-comment
        eword-analyze-spaces
        eword-analyze-special
        eword-analyze-encoded-word
        eword-analyze-atom))
     #+end_src
**** Subject が変わってもスレッドを切らない
     :PROPERTIES:
     :CUSTOM_ID: org8e1a38e8
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-summary-divide-thread-when-subject-changed nil)
     #+end_src
**** Subject での Tab や複数スペースを無視
     :PROPERTIES:
     :CUSTOM_ID: org4a68d8d4
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(defadvice std11-unfold-string (after simply activate)
  (setq ad-return-value
        (elmo-replace-in-string ad-return-value "[ \t]+" " ")))
     #+end_src
**** 重複メッセージを非表示に
     :PROPERTIES:
     :CUSTOM_ID: org84fec166
     :END:
     フォルダ内の Message-ID が同じメールを非表示にする
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-folder-process-duplicates-alist
      '(
        (".*" . hide)
        ))
     #+end_src
**** sort 順: 返信が来た順
     :PROPERTIES:
     :CUSTOM_ID: orgc0e5bbcf
     :END:
     元ネタは [[http://ikazuhiro.s206.xrea.com/article.php/20140920115345919][Re: wanderlust で GMail 風、新着レス順にソート]].
     あんまり頑張る気がなかったので =el-x= にある =dflet= を使っている。
     #+begin_src emacs-lisp  :tangle init-wl.el
(defun wl-summary-overview-entity-compare-by-reply-date (a b)
  "Compare message A and B by latest date of replies including thread."
  (dflet ((string-max2 (x y) (cond ((string< x y) y)
                                  ('t x)))
         (elmo-entity-to-number (x)
                                (elt (cddr x) 0))
         (thread-number-get-date (x)
                                 (timezone-make-date-sortable
                                  (elmo-msgdb-overview-entity-get-date
                                   (elmo-message-entity
                                    wl-summary-buffer-elmo-folder
                                    x))))
         (thread-get-family (x)
                            (cons x (wl-thread-entity-get-descendant
                                     (wl-thread-get-entity x))))
         (max-reply-date  (x)
                          (cond ((eq 'nil x)
                                 'nil)
                                ((eq 'nil (cdr x))
                                 (thread-number-get-date (car x)))
                                ('t
                                 (string-max2 (thread-number-get-date (car x))
                                              (max-reply-date (cdr x))))))
         )
    (string<
     (max-reply-date (thread-get-family (elmo-entity-to-number a)))
     (max-reply-date (thread-get-family (elmo-entity-to-number b))))))
(add-to-list 'wl-summary-sort-specs 'reply-date)
(setq wl-summary-default-sort-spec 'reply-date)
     #+end_src
*** 振り分け設定
    :PROPERTIES:
    :CUSTOM_ID: orgbeaff272
    :END:
    =$= 以外を振り分け対象に
    #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-summary-auto-refile-skip-marks '("$"))
    #+end_src
**** 振り分け判定に使用するヘッダ
     :PROPERTIES:
     :CUSTOM_ID: org1581be27
     :END:
     添付の有無の表示にも使うので =Content-Type= も登録.
     あと =Delivered-To= はメールの検索の時に結構重宝している.
     #+begin_src emacs-lisp :tangle init-wl.el
(setq elmo-msgdb-extra-fields
      '(
        "List-Post"
        "List-Id"
        "List-ID"                  ;; たまに List-ID で来るメールあるよね?
        "Resent-CC"
        "Mailing-List"
        "X-Mailing-List"
        "X-ML-Address"
        "X-ML-Name"
        "X-ML-To"
        "X-Loop"
        "Delivered-To"
        "Content-Type"              ;; 添付の有無の表示の為に追加
        "X-Google-Appengine-App-Id" ;; GAEの送信するメールの振り分け用
        "To"
        "Cc"
        "From"
        "Subject"
        "Reply-To"
        "Auto-Submitted"            ;; Git commit/Cron notify
        ))
     #+end_src
*** メッセージ表示
    :PROPERTIES:
    :CUSTOM_ID: org1c00dc9a
    :END:
**** いったん全て非表示に
     :PROPERTIES:
     :CUSTOM_ID: orgbdcad743
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-message-ignored-field-list '("^.*:"))
     #+end_src
**** 見たいヘッダだけ表示
     :PROPERTIES:
     :CUSTOM_ID: org279f859d
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-message-visible-field-list
      '("^Subject:"
        "^From:"
        "^To:"
        "^Cc:"
        "^Date:"
        "^Message-ID:"
        ))
     #+end_src
**** 表示順の変更
     :PROPERTIES:
     :CUSTOM_ID: org594e5622
     :END:
     Mew 風...
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-message-sort-field-list
      '("^Subject:"
        "^From:"
        "^To:"
        "^Cc:"
        "^Date:"
        "^Message-ID:"
        ))
     #+end_src
**** From, To を省略表示しない
     :PROPERTIES:
     :CUSTOM_ID: org452d7cdb
     :END:
     To や From にアドレスが沢山指定されていると省略されるので, これを無効化
     #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-message-use-header-narrowing nil)
     #+end_src
*** Wanderlust: Face の設定
    :PROPERTIES:
    :CUSTOM_ID: org1bf4b420
    :END:
    デフォルトより細かく指定するために幾つかの face 定義を追加.
    #+begin_src emacs-lisp :tangle init-wl.el
(setq wl-highlight-message-header-alist
      '(("Subject[ \t]*:"
         . wl-highlight-message-subject-header-contents)
        ("From[ \t]*:"
         . wl-highlight-message-from-header-contents)
        ("Date[ \t]*:"
         . wl-highlight-message-date-header-contents)
        ("\\(.*To\\|Cc\\|Newsgroups\\)[ \t]*:"
         . wl-highlight-message-important-header-contents)
        ("\\(User-Agent\\|X-Mailer\\|X-Newsreader\\)[ \t]*:"
         . wl-highlight-message-unimportant-header-contents)
        ))
    #+end_src
    face の色付け
    #+begin_src emacs-lisp :tangle init-wl.el
(defun my:wl-set-face (face spec)
  (make-face face)
  (cond ((fboundp 'face-spec-set)
         (face-spec-set face spec))
        (t
         (wl-declare-face face spec))))
(my:wl-set-face 'wl-highlight-folder-closed-face
                '((t (:foreground "#4cff4c" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-folder-few-face
                '((t (:foreground "#FF4C4C" :bold t :italic nil :weight bold ))))
(my:wl-set-face 'wl-highlight-folder-zero-face
                '((t (:foreground "#f6f3e8" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-1
                '((t (:foreground "#7fff7f" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-2
                '((t (:foreground "#ffff7f" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-3
                '((t (:foreground "#7f7fff" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-4
                '((t (:foreground "#7fffff" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-5
                '((t (:foreground "#ff7fff" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-6
                '((t (:foreground "#ff7f7f" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-7
                '((t (:foreground "#4cff4c" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-8
                '((t (:foreground "#ffff4c" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-9
                '((t (:foreground "#4c4cff" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-10
                '((t (:foreground "#4cffff" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-11
                '((t (:foreground "#ff4cff" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-cited-text-12
                '((t (:foreground "#ff4c4c" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-date-header-contents
                '((t (:foreground "#4CFF4C" :bold t :italic nil :weight bold ))))
(my:wl-set-face 'wl-highlight-message-header-contents
                '((t (:foreground "#aaaaaa" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-headers
                '((t (:foreground "#4CFFFF" :bold t :italic nil :weight bold ))))
(my:wl-set-face 'wl-highlight-message-important-header-contents2
                '((t (:foreground "#4CFF4C" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-signature
                '((t (:foreground "#aaaaaa" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-message-important-header-contents
                '((t (:foreground "#FF4CFF" :bold t :italic nil :weight bold ))))
(my:wl-set-face 'wl-highlight-message-subject-header-contents
                '((t (:foreground "#FF4C4C" :bold t :italic nil :weight bold ))))
(my:wl-set-face 'wl-highlight-message-from-header-contents
                '((t (:foreground "#FFFF4C" :bold t :italic nil :weight bold ))))
(my:wl-set-face 'wl-highlight-message-unimportant-header-contents
                '((t (:foreground "#aaaaaa" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-summary-answered-face
                '((t (:foreground "#4CFF4C" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-summary-refiled-face
                '((t (:foreground "#7F7FFF" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-summary-thread-top-face
                '((t (:foreground "#F6F3E8" :bold nil :italic nil :weight normal ))))
(my:wl-set-face 'wl-highlight-summary-important-flag-face
                '((t (:foreground "#ffff4c" :bold nil :italic nil :weight normal ))))
;;
;; (my:wl-set-face 'wl-highlight-folder-killed-face
;;                 '((t (:foreground ,my:h:black :5Dbold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-folder-many-face
;;                 '((t (:foreground ,my:h:magenta :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-folder-opened-face
;;                 '((t (:foreground "#4cffff" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-folder-path-face
;;                 '((t (:underline t :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-folder-unknown-face
;;                 '((t (:foreground "#4cffff" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-folder-unread-face
;;                 '((t (:foreground ,my:n:blue :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-header-separator-face
;;                 '((t (:inherit highlight :bold t ))))
;; (my:wl-set-face 'wl-highlight-message-citation-header
;;                 '((t (:foreground ,my:h:green :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-copied-face
;;                 '((t (:foreground "#4CFFFF" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-deleted-face
;;                 '((t (:foreground ,my:h:black :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-displaying-face
;;                 '((t (:underline t :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-disposed-face
;;                 '((t (:foreground "#aaaaaa" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-flagged-face
;;                 '((t (:foreground ,my:h:yellow :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-forwarded-face
;;                 '((t (:foreground ,my:h:blue :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-high-read-face
;;                 '((t (:foreground ,my:h:green :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-high-unread-face
;;                 '((t (:foreground ,my:h:orange :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-important-face
;;                 '((t (:foreground "#ffff4c" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-killed-face
;;                 '((t (:foreground ,my:h:black :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-l:read-face
;;                 '((t (:foreground "#4CFF4C" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-l:unread-face
;;                 '((t (:foreground ,my:h:lightb :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-new-face
;;                 '((t (:foreground "#ff4c4c" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-normal-face
;;                 '((t (:foreground "#f6f3e8" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-prefetch-face
;;                 '((t (:foreground ,my:n:blue :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-resend-face
;;                 '((t (:foreground ,my:h:orange :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-target-face
;;                 '((t (:foreground "#4CFFFF" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-temp-face
;;                 '((t (:foreground ,my:n:violet :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-summary-unread-face
;;                 '((t (:foreground "#ff4c4c" :bold nil :italic nil ))))
;; (my:wl-set-face 'wl-highlight-thread-indent-face
;;                 '((t (:underline t :bold nil :italic nil ))))
    #+end_src
*** 作成/返信設定
    :PROPERTIES:
    :CUSTOM_ID: org32b816f3
    :END:
    自分宛のメールに返信する場合は =To:=, =Cc:= から自分のアドレスを削除
    #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-draft-always-delete-myself t)
    #+end_src
    "a" (without-argument)では =Reply-To:= や =From:= などで
    指定された唯一人または唯一つの投稿先に返信.
    また, =X-ML-Name:= と =Reply-To:= がついているなら =Reply-To:= 宛に返信
    #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-draft-reply-without-argument-list
      '((("X-ML-Name" "Reply-To") . (("Reply-To") nil nil))
        ("X-ML-Name" . (("To" "Cc") nil nil))
        ("Followup-To" . (nil nil ("Followup-To")))
        ("Newsgroups" . (nil nil ("Newsgroups")))
        ("Reply-To" . (("Reply-To") nil nil))
        ("Mail-Reply-To" . (("Mail-Reply-To") nil nil))
        ("From" . (("From") nil nil))))
    #+end_src
    =C-u a= (with-argument)であれば関係する全ての人・投稿先に返信
    #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-draft-reply-with-argument-list
      '(("Followup-To" . (("From") nil ("Followup-To")))
        ("Newsgroups" . (("From") nil ("Newsgroups")))
        ("Mail-Followup-To" . (("Mail-Followup-To") nil ("Newsgroups")))
        ("From" . (("From") ("To" "Cc") ("Newsgroups")))))
    #+end_src
    サマリ表示には petname を使うが, 引用には使わない
    #+begin_src emacs-lisp  :tangle init-wl.el
(setq wl-default-draft-cite-decorate-author nil)
    #+end_src
**** メール本文の文字コード
     :PROPERTIES:
     :CUSTOM_ID: orgccd69748
     :END:
     丸囲み数字なんかが入ってしまうと
     勝手にエンコーディングが変わってしまって鬱陶しい. どうしたモンだろうかね.
     #+begin_src emacs-lisp :tangle no
(add-hook 'wl-draft-mode-hook
          (lambda ()
            (add-to-list 'mime-charset-type-list '(utf-8 8 nil))))
     #+end_src
**** draft mode で orgtbl を有効に
     :PROPERTIES:
     :CUSTOM_ID: org62a575b3
     :END:
     #+begin_src emacs-lisp  :tangle init-wl.el
(add-hook 'wl-draft-mode-hook 'turn-on-orgtbl)
     #+end_src
**** c-sig
     :PROPERTIES:
     :CUSTOM_ID: orgc1db3638
     :END:
     署名の選択に c-sig を使用している.
     設定は以下の通り. Mew 風に =C-c <tab>= で signature を挿入するようにしている
     #+begin_src emacs-lisp  :tangle init-wl.el
(leaf c-sig
  :config
  (eval-when-compile (require 'wl))
  (setq sig-insert-end t
        sig-save-to-sig-name-alist nil
        message-signature-file nil)
  (define-key wl-draft-mode-map "\C-c\t" 'insert-signature-eref)
  (add-hook 'wl-draft-mode-hook
            '(lambda ()
               (define-key (current-local-map) "\C-c\C-w"
                 'insert-signature-eref)))
  )
     #+end_src
*** GPG 署名
    :PROPERTIES:
    :CUSTOM_ID: orgda22b5d8
    :END:
    以前は mailcrypt を使っていたけれど,
    epa があるので主にキーバインドの設定のみ.
    =draft-mode= の文字コードをあらかじめ指定しておかないと,
    送信時に文字コードが変換されるので不正な署名となってしまう.

    もっとうまい方法/正攻法がありそうな気がするけれど,
    使えてるから, まあ良いかな, とか.
    #+begin_src emacs-lisp :tangle init-wl.el
(setq mime-pgp-verify-when-preview nil)
(defun my:epa-wl-decrypt-message ()
  (interactive)
  (save-window-excursion
    (wl-summary-jump-to-current-message)
    (wl-message-decrypt-pgp-nonmime)))
(defun my:epa-wl-verify-message ()
  (interactive)
  (save-selected-window
    (wl-summary-jump-to-current-message)
    (wl-message-verify-pgp-nonmime)))
(leaf-keys ((:wl-summary-mode-map
             ("C-c : d" . my:epa-wl-decrypt-message)
             ("C-c : v" . my:epa-wl-verify-message))
            (:wl-draft-mode-map
             ("C-c : s" . epa-mail-sign)
             ("C-c : e" . epa-mail-encrypt)))
           )
    #+end_src
*** 検索
    :PROPERTIES:
    :CUSTOM_ID: org5d7309d7
    :END:
    notmuchを使う.
    #+begin_src emacs-lisp  :tangle init-wl.el
(leaf elmo-search
  :config
  (elmo-search-register-engine 'notmuch-custom 'local-file
                               :prog "notmuch-query-custom"
                               :args '(elmo-search-split-pattern-list)
                               :charset 'utf-8)
  (setq elmo-search-default-engine 'notmuch-custom))
(leaf wl-qs
  :config
  (setq wl-quicksearch-folder "[]"
        )
  )
(leaf-keys ((:wl-summary-mode-map
             ("v" . wl-quicksearch-goto-search-folder-wrapper))
            (:wl-folder-mode-map
             ("v" . wl-quicksearch-goto-search-folder-wrapper)))
           )
    #+end_src
    実際の呼び出しはスレッドを全部取得したいので以下を呼び出している
    #+begin_src sh :tangle no
#!/bin/sh
if [ ! x"$*" = x"" ] ; then
    res=$(notmuch search --output=threads "$*")
fi
if [ ! x"$res" = x"" ] ; then
    echo $res | xargs notmuch search --sort=oldest-first --output=files
fi
    #+end_src
    検索時にメールが多すぎると怒られるので. 数字は適当.
    #+begin_src emacs-lisp  :tangle init-wl.el
(setq elmo-multi-divide-number 2000000000)
(setq elmo-multi-number 2000000000)
    #+end_src
** Linux Desktop で =mailto:= リンクを扱うために
   :PROPERTIES:
   :CUSTOM_ID: orgcfa9b17b
   :END:
   ついでに =mailto= のリンクを emacsclient で扱うために,
   以下の関数を定義しておく
   #+begin_src emacs-lisp
(defun my:mailto-compose-mail (mailto-url)
  "Custom: handling mailto: link"
  (if (and (stringp mailto-url)
           (string-match "\\`mailto:" mailto-url))
      (progn
        (eval-and-compile (require 'rfc2368))
        (let* ((headers (mapcar (lambda (h) (cons (intern (car h)) (cdr h)))
                                (rfc2368-parse-mailto-url mailto-url)))
               (good-headers (cl-remove-if (lambda (h) (member (car h) '(Body))) headers))
               (body (cdr (assoc 'Body headers))))
          (wl-draft good-headers nil nil body)))))
   #+end_src
   Desktop の設定では
   #+begin_src sh :tangle no
#!/bin/sh
# emacs-mailto-handler

mailto=$1
mailto="mailto:${mailto#mailto:}"
mailto=$(printf '%s\n' "$mailto" | sed -e 's/[\"]/\\&/g')
elisp_expr="(my:mailto-compose-mail \"$mailto\")"

emacsclient -a "" -n --eval "$elisp_expr" \
            '(set-window-dedicated-p (selected-window) t)'
   #+end_src
   をメーラとして指定すれば良い．
   GNOME は =.desktop= ファイルが無いと「お気に入り」登録ができないので
   以下のファイルを適当な名前で =~/.local/share/applications/= 以下に放り込んでおくと良いだろう
   #+begin_src conf :tangle no
[Desktop Entry]
Name=Emacs Mail Handler
GenericName=Mail User Agent
X-GNOME-FullName=Emacs Mail Handler
Comment=Use emacsclient as MUA, handling mailto link
Keywords=email
Exec=/home/uwabami/bin/emacs-mailto-handler %U
Icon=emacs25
Terminal=false
Type=Application
Categories=GNOME;GTK;Office;Email;
StartupNotify=false
MimeType=application/mbox;message/rfc822;x-scheme-handler/mailto;
   #+end_src
** メールからの予定の取り込み: =mhc=
   :PROPERTIES:
   :CUSTOM_ID: org215a97b9
   :END:
   #+begin_src emacs-lisp
(leaf mhc
  :if (file-directory-p (concat (getenv "HOME") "/.config/mhc"))
  :ensure t
  :commands (mhc-import)
  :init
  (setq mhc-calendar-day-strings ["日" "月" "火" "水" "木" "金" "土"]
        mhc-calendar-header-function 'mhc-calendar-make-header-ja
        mhc-calendar-language 'japanese)
  )
   #+end_src
* 閉じタグの入力補助: =smartparens=
  :PROPERTIES:
  :CUSTOM_ID: orgc0b8a536
  :END:
  #+BEGIN_SRC emacs-lisp
(leaf smartparens
  :disabled t
  :ensure t
  :diminish (smartparens-mode "")
  :defun (sp-pair)
  :hook (after-init-hook . smartparens-global-mode)
  :config
  (require 'smartparens-config)
  (sp-pair "=" "=" :actions '(wrap))
  (sp-pair "+" "+" :actions '(wrap))
  (sp-pair "<" ">" :actions '(wrap))
  (sp-pair "$" "$" :actions '(wrap))
  )
  #+END_SRC
* カラーコードに色付け: =rainbow-mode=
  :PROPERTIES:
  :CUSTOM_ID: org1f0e431b
  :END:
  =#RRGGBB= のカラーコードに勝手に色が付く．CSS の編集中なんかで地味に便利．
  #+begin_src emacs-lisp
(leaf rainbow-mode
  :ensure t
  :config
  (with-eval-after-load 'rainbow-mode
    (diminish 'rainbow-mode (format " %s" "\x1F308")))
  )
  #+end_src
  モードラインの調整が上手く動いていない気がする(=:diminish= が効かない).
  しょうがないので =with-eval-after-load= で．
* 対応する括弧を見易く: =rainbow-delimiters=
  :PROPERTIES:
  :CUSTOM_ID: orgdddd3388
  :END:
  対応する括弧を強調表示してくれる
  [[https://www.emacswiki.org/emacs/RainbowDelimiters][RainbowDelimiters]]:
  global に有効にするのは他の
  Major modeとの衝突があるので止めた方が良い, らしい．
  #+begin_src emacs-lisp
(leaf rainbow-delimiters
  :ensure t
  :diminish ""
  :hook (prog-mode-hook . rainbow-delimiters-mode)
  )
  #+end_src
* Org-mode
  :PROPERTIES:
  :CUSTOM_ID: org7b7eccc9
  :END:
  =org-mode= が無いと生きていけない体になりました
** 基本設定: =org=
   :PROPERTIES:
   :CUSTOM_ID: orgb143e870
   :END:
   目新しい設定はしていない, と思う．
   #+begin_src emacs-lisp
(leaf org
  :delight (org-mode (all-the-icons-icon-for-mode 'org-mode))
  :bind (("C-x n s" . org-narrow-to-subtree)
         ("C-x n w" . widen))
  :mode
  ;; 昔のメモ(howm)も org-mode で開く
  (("\\.org\\'" "\\.howm\\'". org-mode))
  :preface
  ;;; timestamp 更新文字列の変更:
  ;;  org-mode では ＃+DATE: をひっかける用に(＃は小文字)．
  (defun my:org-timestamp-hook ()
    "Change `time-stamp-start' in org-mode"
    (set (make-local-variable 'time-stamp-start) "#\\+date: 2")
    (set (make-local-variable 'time-stamp-end)   "\$")
    )
  ;; GTD: TODO→...→DONE としたエントリを =Arhive.org= に移動
  (defun my:org-archive-done-tasks ()
    (interactive)
    (org-map-entries 'org-archive-subtree "/DONE" 'file))
  :hook
  ((org-mode-hook                  . my:org-timestamp-hook)
   (org-todo-statistics-hook       . my:org-archive-done-tasks)
   (org-todo-after-statistics-hook . my:org-archive-done-tasks))
  :custom
  `(;; Nextcloud に保存する
    (org-directory              . ,(expand-file-name my:d:org))
    ;; return でリンクを辿る
    (org-return-follows-link    . t)
    ;; 見出しを畳んで表示
    (org-startup-folded         . t)
    ;; 折り返し無し
    (org-startup-truncated      . t)
    ;; link handler -> xdg-open 任せ
    (org-file-apps-defaults     . '((remote . emacs)
                                    (system . "xdg-open %s")
                                    (t      . "xdg-open %s")))
    (org-file-apps-defaults-gnu . '((remote . emacs)
                                    (system . "xdg-open %s")
                                    (t      . "xdg-open %s")))
    ;; GTD: 状態の追加
    (org-todo-keywords          . '((sequence "TODO(t)" "WAIT(w)" "|" "DONE(d)" "CANCEL(c)" "SOMEDAY(s)")
                                    (type "ARTICLE(a)")
                                    (type "MEMO(m)")))
    ;; GTD: タグの追加
    (org-tag-alist              . '(("OFFICE"     . ?o)
                                    ("HOME"       . ?h)
                                    ("MAIL"       . ?m)
                                    ("WORK"       . ?w)
                                    ("Debian"     . ?d)
                                    ("Computer"   . ?c)
                                    ("Book"       . ?b)
                                    ("Emacs"      . ?e)
                                    ("TeX"        . ?t)
                                    ("Ruby"       . ?r)))
    ;; DONE → Archive.org に移動
    (org-archive-location       . "Archive.org::")
    ;; modules → とりあえずクリアしておく
    (org-modules  . '())
    )
  :config
  ;; +打ち消し+ の font-lock の変更 →これはテーマに任せるべき?
  (setq org-emphasis-alist
        (cons '("+" '(:strike-through t :foreground "#999999"))
              (cl-delete "+" org-emphasis-alist :key 'car :test 'equal)))
  )
   #+end_src
** Org-Id
   :PROPERTIES:
   :CUSTOM_ID: org67465ee0
   :END:
   #+begin_src emacs-lisp
(leaf org-id
  :custom
  `((org-id-locations-file . ,(expand-file-name "org-id-locations" my:d:share))
    ;; (org-id-link-to-org-use-id . create-if-interactive-and-no-custom-id)
    )
  :config
  (defun my:add-custom-id ()
    "Add \"CUSTOM_ID\" to the current tree if not assigned yet."
    (interactive)
    (my:org-custom-id-get nil t))
  ;;
  (defun my:get-custom-id ()
    "Return a part of UUID with an \"org\" prefix.
e.g. \"org3ca6ef0c\"."
    (let* ((id (org-id-new "")))
      (when (org-uuidgen-p id)
        (downcase (concat "org"  (substring (org-id-new "") 0 8))))))
  ;;
  (defun my:org-custom-id-get (&optional pom create)
    "Get the CUSTOM_ID property of the entry at point-or-marker POM.
See https://writequit.org/articles/emacs-org-mode-generate-ids.html"
    (interactive)
    (require 'org-macs nil 'noerror)
    (org-with-point-at pom
      (let ((id (org-entry-get nil "CUSTOM_ID")))
        (cond
         ((and id (stringp id) (string-match "\\S-" id))
          id)
         (create
          (setq id (my:get-custom-id))
          (unless id
            (error "Invalid ID"))
          (org-entry-put pom "CUSTOM_ID" id)
          (message "--- CUSTOM_ID assigned: %s" id)
          (org-id-add-location id (buffer-file-name (buffer-base-buffer)))
          id)))))
  ;;
  (defun my:delete-all-id-in-file ()
    (interactive)
    (goto-char 1)
    (while (not (eq (point) (point-max)))
      (org-next-visible-heading 1)
      (let ((id (org-entry-get (point) "ID")))
        (when id
          (message "ID: %s" id)
          (org-delete-property "ID"))))
    (message "--- done."))
  :config
  (defun my:org-id-add-to-headlines-in-file ()
    "Add CUSTOM_ID properties to all headlines in the current file.
See https://writequit.org/articles/emacs-org-mode-generate-ids.html"
    (interactive)
    (save-excursion
      (widen)
      (goto-char (point-min))
      (when (re-search-forward "^#\\+options:.*auto-id:t" (point-max) t)
        (org-map-entries
         (lambda () (my:org-custom-id-get (point) 'create))))))
  (add-hook 'before-save-hook 'my:org-id-add-to-headlines-in-file)
  )
   #+end_src
** Babel
   :PROPERTIES:
   :CUSTOM_ID: org99399f3b
   :END:
   #+begin_src emacs-lisp
(leaf org-babel
  :after all-the-icons-in-terminal
  :diminish (org-src-mode (format " %s" (all-the-icons-octicon "code")))
  :custom
  (;; font-lock
   (org-src-fontify-natively         . t)
   ;; TAB の挙動
   (org-src-tab-acts-natively        . t)
   ;; インデント
   (org-edit-src-content-indentation . 0)
   ;; インデントを残す
   (org-src-preserve-indentation     . t))
  )
   #+end_src
** Agenda: スケジュール, TODO 表示
   :PROPERTIES:
   :CUSTOM_ID: org016dbf67
   :END:
   GTD 用の設定．後述の =org-gcal= と =orgmine= で取得したデータも表示している．
   ついでに
   - 土曜日をの face を追加.
   - 祝日, 休日を日曜と同じfaceにする.
   なんて事もやっている．元ネタは [[https://julien.danjou.info/blog/2010/org-mode-and-holidays][Org-mode and holidays]]
   #+begin_src emacs-lisp
(leaf org-agenda
  :bind (("C-c a" . org-agenda))
  :init
  ;; イケてない...
  (require 'japanese-holidays)
  ;;
  (defface my:org-agenda-date-saturday
    '((t (:foreground "#7FBFFF" :bold t )))
    "Agenda 表示中の土曜日用のface")
  (defface my:org-agenda-date-today-saturday
    '((t (:inherit my:org-agenda-date-saturday :underline t)))
    "Agenda 表示中の今日かつ土曜日用のface")
  (defface my:org-agenda-date-today-weekend
    '((t (:inherit org-agenda-date-weekend :underline t)))
    "Agenda 表示中の今日かつ日・祝日用のface")
  ;; こっからは org-gcal で同期したカレンダーの色
  (defface my:org-agenda-calendar-Univ
    '((t (:foreground "#7FFF7F")))
    "Agenda 表示中, Univ.org の表示 face"
    :group 'org-agenda )
  (defface my:org-agenda-calendar-Schedule
    '((t (:foreground "#7FFFFF")))
    "Agenda 表示中, Schedule.org の表示 face"
    :group 'org-agenda )
  (defface my:org-agenda-calendar-GFD
    '((t (:foreground "#FFFF7F")))
    "Agenda 表示中, GFD.org の表示 face"
    :group 'org-agenda )
  (defface my:org-agenda-calendar-DebianJP
    '((t (:foreground "#BF7FFF")))
    "Agenda 表示中, DebianJP.org の表示 face"
    :group 'org-agenda )
  (defface my:org-agenda-calendar-twitter
    '((t (:foreground "#CCCCCC")))
    "Agenda 表示中, Twitter log の表示 face"
    :group 'org-agenda )
  ;; 更新用の関数 - とりあえず動いているので良しとするが,
  ;; リファクタリングしたい
  (defun my:org-agenda-day-face-function (date)
    "Compute DATE face for saturday, holidays."
    (cl-dolist (file (org-agenda-files nil 'ifmode))
      (cond
       ((member (calendar-day-of-week date) '(0))
        (if (org-agenda-todayp date)
            (cl-return 'my:org-agenda-date-today-weekend))
        (cl-return 'org-agenda-date-weekend))
       ((member (calendar-day-of-week date) '(6))
        (if (org-agenda-todayp date)
            (cl-return 'my:org-agenda-date-today-saturday))
        (cl-return 'my:org-agenda-date-saturday)))
      (let ((face
             (cl-dolist (entry (org-agenda-get-day-entries file date))
               (let ((category (with-temp-buffer
                                 (insert entry)
                                 (org-get-category (point-min)))))
                 (when (or (string= "祝日" category)
                           (string= "休日" category))
                   (if (org-agenda-todayp date)
                       (cl-return 'my:org-agenda-date-today-weekend)
                     (cl-return 'org-agenda-date-weekend)))))))
        (when face (cl-return face)))))
  ;; font-lock の適用
  (defun my:org-agenda-finalize-font-lock ()
    "Custom: apply custom font-lock"
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward "Univ:" nil t)
        (add-text-properties
         (match-beginning 0) (point-at-eol)
         '(face my:org-agenda-calendar-Univ)))
      (goto-char (point-min))
      (while (re-search-forward "Schedule:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face my:org-agenda-calendar-Schedule)))
      (goto-char (point-min))
      (while (re-search-forward "MHC:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face my:org-agenda-calendar-Schedule)))
      (goto-char (point-min))
      (while (re-search-forward "DebianJP:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face my:org-agenda-calendar-DebianJP)))
      (goto-char (point-min))
      (while (re-search-forward "GFD:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face my:org-agenda-calendar-GFD)))
      (goto-char (point-min))
      (while (re-search-forward "twitter:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face my:org-agenda-calendar-twitter)))
      (goto-char (point-min))
      (while (re-search-forward "誕生日:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face org-agenda-date-weekend)))
      (goto-char (point-min))
      (while (re-search-forward "祝日:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face org-agenda-date-weekend)))
      (goto-char (point-min))
      (while (re-search-forward "休日:" nil t)
        (add-text-properties (match-beginning 0) (point-at-eol)
                             '(face org-agenda-date-weekend)))))
  :hook
  ;; 色付け
  ((org-agenda-finalize-hook . my:org-agenda-finalize-font-lock))
  :custom
  (;; day or week
   (org-agenda-span              . 'day)
   ;; YY/MM/DD (曜)
   (org-agenda-format-date       . "%Y/%m/%d (%a)")
   ;; 日曜始まり
   (org-agenda-weekend-days      . '(0))
   ;; 表示関数
   (org-agenda-day-face-function . 'my:org-agenda-day-face-function)
   ;; GTD 用の設定
   (org-agenda-custom-commands
    . '(
        ("n" "agenda and all TODO list"
         (
          (agenda ""
                  ((org-agenda-ndays 1)
                   (org-agenda-entry-types '(:timestamp :sexp))))
          (todo "TODO"
                ((org-agenda-prefix-format " %i %-22:c")))
          (todo "新規|着手|進行中|確認"
                ((org-agenda-prefix-format " %i %-22:c")))
          (todo "WAIT"
                ((org-agenda-prefix-format " %i %-22:c")))

          (todo "SOMEDAY"
                ((org-agenda-prefix-format " %i %-22:c")))
          ))
        ("N" "All memo entry"
         (;;
          (todo "MEMO")
          ))
        )))
  :config
  ;; 使用するファイル
  (dolist (file
           '("Archive.org"
             "Holidays.org"
             "Memo.org"
             "Schedule.org"
             "MHC.org"
             "GFD.org"
             "Univ.org"
             "DebianJP.org"
             "twitter.org"
             "journal.org"
             "redmine_GFD.org"
             "redmine_FluidSoc.org"
             "web.org"
             ))
    (add-to-list 'org-agenda-files (expand-file-name file my:d:org)))
  (add-to-list 'org-agenda-files (locate-user-emacs-file "README.org"))
  )
   #+end_src
** Org-journal: 日記
   :PROPERTIES:
   :CUSTOM_ID: org456c87fa
   :END:
   機能が豊富なのだが, イマイチ使いこなせていない.
   #+begin_src emacs-lisp
(leaf org-journal
  :if (and (file-directory-p my:d:org)
           (>= emacs-major-version 25))
  :ensure t
  :bind (("C-x M"    . my:org-journal-new-entry)
         (:org-journal-mode-map
          ("C-c C-c" . my:org-journal-entry-save-and-exit)))
  :init
  (defun my:org-journal-new-entry (prefix &optional time)
    "Add new journal entry on new elscreen"
    (interactive "P")
    (elscreen-create)
    (org-journal-new-entry prefix time))

  (defun my:org-journal-entry-save-and-exit ()
    "Save journal entry and close elscreen buffer"
    (interactive)
    (save-buffer)
    (elscreen-kill))
  :hook
  ((org-journal-mode-hook
    . (lambda()
        (setq-local truncate-lines t))))
  :custom
  `((org-journal-dir                       . ,(expand-file-name "journal/" my:d:org))
    (org-journal-date-format               . "%x (%a)")
    (org-journal-enable-agenda-integration . t)
    (org-journal-file-format               . "%Y-%m-%d.org")
    (org-journal-time-format               . "<%Y-%m-%d %R> ")
    (org-journal-time-prefix               . "** MEMO ")
    (org-journal-find-file                 . 'find-file)
    (org-journal-cache-file
     . ,(expand-file-name "org-journal.cache" my:d:tmp)))
  :config
  (eval-and-compile 'browse-url)
  (with-eval-after-load 'org-journal
    (global-set-key (kbd "C-c C-j") 'browse-url-at-point))
  )
   #+end_src
** Capture: メモ取り
   :PROPERTIES:
   :CUSTOM_ID: orgbe835a6b
   :END:
   キーバインドは以前 changelog memo をやっていた時の癖で =C-x m= をメモにしている.
   他には wanderlust のメールを扱えるように =org-wl= を読み込んで template を追加したぐらい.
   notmuch のインデックスの方が良いかもしれない, と最近思っている.
   #+begin_src emacs-lisp
(leaf ol-wl
  :if (and (or (my:dpkg-status "wl-beta")
               (my:dpkg-status "wl"))
           (file-directory-p my:d:org))
  :el-get (ol-wl
           :url "https://code.orgmode.org/bzg/org-mode/raw/master/contrib/lisp/ol-wl.el"
           )
  )
(leaf org-capture
  :if (file-directory-p my:d:org)
  :bind (("C-x m" . org-capture))
  :config
  (defun my:org-journal-add-date-entry-capture ()
    (org-journal-new-entry t)
    (goto-char (point-max))
    )
  ;; @see https://github.com/sprig/org-capture-extension/issues/37
  ;; Brackets '{' '}' in link description cause broken org-mode link #37]]
  (defun my:transform-square-brackets-to-round-ones (string-to-transform)
    "Transforms [ into ( and ] into ), other chars left unchanged."
    (concat
     (mapcar #'(lambda (c) (if (equal c ?\[) ?\( (if (equal c ?\]) ?\) c)))
             string-to-transform))
    )
  (setq org-default-notes-file (concat my:d:org "journal.org")
        org-capture-templates
        `(
          ("t" "TODO" plain
           (function my:org-journal-add-date-entry-capture)
           "** TODO %(format-time-string org-journal-time-format)%^{title} %^g\n  %?\n  %a"
           :prepend nil
           :unnarrowed nil
           :kill-buffer t
           )
          ;; "* TODO <%<%Y-%m-%d>> %:subject %^g\n  %?\n  %a\n  #+BEGIN_QUOTE\n%i\n  #+END_QUOTE"
          ("e" "Email TODO" plain
           (function my:org-journal-add-date-entry-capture)
           "** TODO %(format-time-string org-journal-time-format) [[wl:\%5Bmsgid:%:message-id-no-brackets\%5D][%(my:transform-square-brackets-to-round-ones \"%:subject\")]]\n  :PROPERTIES:\n  :CREATED: %u\n  :END:%?\n"
           :prepend nil
           :unnarrowed nil
           :kill-buffer t
           )
          ("m" "Memo/Journal Entry" plain
           (function my:org-journal-add-date-entry-capture)
           "** MEMO %(format-time-string org-journal-time-format) %?"
           :prepend nil
           :unnarrowed nil
           :kill-buffer t
           )
          ("a" "Aritcle Entry" plain
           (function my:org-journal-add-date-entry-capture)
           "** ARTICLE %(format-time-string org-journal-time-format) %? "
           :prepend nil
           :unnarrowed nil
           :kill-buffer t
           )
          )
        )
  )
   #+end_src
** OrgとGoogle カレンダーの連携: =org-gcal=
   :PROPERTIES:
   :CUSTOM_ID: org6a1d2f0c
   :END:
   request token 等の置き場所の変更
   実際の情報等は =password-store= を使って設定しておく.
   ついでに agenda 表示の際の色付けを設定．
   #+begin_src emacs-lisp
(leaf org-gcal
  :if (and my:d:password-store
           (file-directory-p my:d:org))
  :ensure t
  :commands (org-gcal-fetch org-gcal-sync)
  :preface
  (setq org-gcal-dir (expand-file-name "org-gcal" my:d:tmp))
  (unless (file-directory-p org-gcal-dir)
    (make-directory org-gcal-dir))
  :init
  (leaf request
    :ensure t
    :preface
    (setq request-storage-directory (expand-file-name "request" my:d:tmp))
    (unless (file-directory-p request-storage-directory)
      (make-directory request-storage-directory))
    :config
    (setq request-storage-directory (expand-file-name "request" my:d:tmp))
    )
  :custom
  `((org-gcal-dir          . ,(expand-file-name
                               "org-gcal" my:d:tmp))
    (org-gcal-token-file   . ,(expand-file-name
                               "org-gcal/.org-gcal-token" my:d:tmp))
    (org-gcal-down-days    . 90)  ;; 過去 3 month
    (org-gcal-up-days      . 180)  ;; 未来 6 month
    (org-gcal-auto-archive . nil)
    (org-gcal-notify-p     . nil)
    ;;
    (alert-log-messages    . t)
    (alert-default-style   .'log))
  :pl-setq
  (org-gcal-client-id
   org-gcal-client-secret
   org-gcal-file-alist)
  )
   #+end_src
** OrgとRedmine の連携: =orgmine=
   :PROPERTIES:
   :CUSTOM_ID: org5908f7b5
   :END:
   素晴しい!!
   [[https://github.com/kametoku/orgmine][kametoku/orgmine: Emacs minor mode for org-mode with redmine integration]]
   #+begin_src emacs-lisp
(leaf *orgmine
  :if  (and my:d:password-store
            (file-directory-p my:d:org))
  :init
  (setq enable-local-variables :safe)
  (leaf elmine :ensure t)
  (add-hook 'org-mode-hook
            (lambda ()
              (if (assoc "om_server" org-file-properties) (orgmine-mode))))
  (leaf orgmine
    :commands (orgmine-mode)
    :el-get (orgmine
             :type github
             :pkgname "kametoku/orgmine")
    :pl-setq orgmine-servers
    :config
    (setq orgmine-note-block-begin "#+begin_src gfm"   ;; 要調整
          orgmine-note-block-end   "#+end_src\n"
          orgmine-default-todo-keyword "新規")
    )
  )
   #+end_src
** Org-Wiki
   :PROPERTIES:
   :CUSTOM_ID: org5f8d1640
   :END:
   #+BEGIN_SRC emacs-lisp
(leaf org-wiki
  :el-get (org-wiki
           :type github
           :pkgname "uwabami/org-wiki")
  :custom
  ((org-wiki-location     . "~/Public/cc-env")
   (org-wiki-publish-root . "{{site.url}}/cc-env/")
   )
  )
   #+END_SRC
** Org-Export
   :PROPERTIES:
   :CUSTOM_ID: org54ab7934
   :END:
*** 全般設定
    :PROPERTIES:
    :CUSTOM_ID: org06031219
    :END:
    latex, beamer,jekyll(後述) のみを有効に.
    #+BEGIN_SRC emacs-lisp
(leaf ox
  :preface
  ;; 空行の削除
  (defun my:remove-org-newlines-at-cjk-text (&optional _mode)
    "先頭が '*', '#', '|' でなく、改行の前後が日本の文字の場合は改行を除去"
    (interactive)
    (goto-char (point-min))
    (while (re-search-forward "^\\([^|#*\n].+\\)\\(.\\)\n *\\(.\\)" nil t)
      (if (and (> (string-to-char (match-string 2)) #x2000)
               (> (string-to-char (match-string 3)) #x2000))
          (replace-match "\\1\\2\\3"))
      (goto-char (point-at-bol))))
  :hook
  ((org-export-before-processing-hook . my:remove-org-newlines-at-cjk-text))
  :custom
  ((org-export-backends             . '(;; remove somve built-in
                                        ;; html
                                        jekyll
                                        latex
                                        beamer))
   (org-export-with-toc             . nil)
   (org-export-with-section-numbers . nil))
  )
    #+END_SRC
*** LaTeX, Beamer
    :PROPERTIES:
    :CUSTOM_ID: org4d9c6533
    :END:
    #+BEGIN_SRC emacs-lisp
(leaf ox-latex
  :after ox
  :init
  (leaf ox-beamer
    :custom
    `((org-beamer-frame-level . 2)
      (org-beamer-frame-default-options . "fragile,squeeze,c")
      )
    :config
    ;; for Beamer
    (add-to-list 'org-export-options-alist
                 '(:shortdate    "SHORTDATE"   nil nil))
    (add-to-list 'org-export-options-alist
                 '(:shorttitle   "SHORTTITLE"  nil nil))
    (add-to-list 'org-export-options-alist
                 '(:shortauthor  "SHORTAUTHOR" nil nil))
    (add-to-list 'org-export-options-alist
                 '(:institute    "INSTITUTE"   nil nil))
    )
  :custom
  `((org-latex-default-class . "my:platex")
    (org-latex-pdf-process   . '("latexmk -pvc %f"))
    (org-latex-classes
     . '(("my:platex"
          "\\documentclass[a4j]{jsarticle}
            [NO-DEFAULT-PACKAGES] [NO-PACKAGES] [EXTRA]"
          ("\\section\{%s\}" . "\\section*\{%s\}")
          ("\\subsection\{%s\}" . "\\subsection*\{%s\}")
          ("\\subsubsection\{%s\}" . "\\subsubsection*\{%s\}"))
         ("my:beamer"
          "\\documentclass[dvipdfmx,presentation]{beamer}
             [NO-DEFAULT-PACKAGES] [NO-PACKAGES] [EXTRA]"
          ("\\section\{%s\}" . "\\section*\{%s\}")
          ("\\subsection\{%s\}" . "\\subsection*\{%s\}")
          ("\\subsubsection\{%s\}" . "\\subsubsection*\{%s\}"))))
    )
  )
    #+END_SRC
*** Jekyll
    :PROPERTIES:
    :CUSTOM_ID: org589a50cc
    :END:
    Web サイトは Jekyll で作成しています.
    以前は org-file を直接 jekyll で処理していましたが,
    最近は org を Markdown に export して, それを処理する様にしています.

    exporter は [[https://uwabami.github.com/ox-jekyll][uwabami/ox-jekyll]] にあります.
    #+BEGIN_SRC emacs-lisp
(leaf ox-jekyll
  :el-get (ox-jekyll
           :type github
           :pkgname "uwabami/ox-jekyll")
  :after ox-html
  :config
  (defun my:org-wiki-jekyll-finalized1 (contents backend info)
    "Replace some URL"
    (when (org-export-derived-backend-p backend 'jekyll)
      (s-replace
       (format "<a href=\"file://%sREADME.html"
               (expand-file-name user-emacs-directory))
       "<a href=\"{{baseurl}}/cc-env/Emacs.html"
       contents)))
  (add-to-list 'org-export-filter-final-output-functions
               'my:org-wiki-jekyll-finalized1)
  (defun my:org-wiki-jekyll-finalized2 (contents backend info)
    "Replace some URL"
    (when (org-export-derived-backend-p backend 'jekyll)
      (s-replace
       (format "<a href=\"file://%s"
               (expand-file-name "Public/" (getenv "HOME")))
       "<a href=\"{{site.url}}/"
       contents)))
  (add-to-list 'org-export-filter-final-output-functions
               'my:org-wiki-jekyll-finalized2)
  )
    #+END_SRC
** Org-Publish
   :PROPERTIES:
   :CUSTOM_ID: orge77c5c82
   :END:
   #+BEGIN_SRC emacs-lisp
(leaf ox-publish
  :after org-wiki
  :config
  (defun org-wiki-publish ()
    (interactive)
    (org-publish (org-wiki-make-org-publish-plist
                  'org-jekyll-publish-to-html)
                 t))
  )
   #+END_SRC
* Outline Magic
  :PROPERTIES:
  :CUSTOM_ID: org912b87a3
  :END:
  どんどん増えそう．
  #+BEGIN_SRC emacs-lisp
(leaf outline
  :init
  (leaf outline-magic
    :ensure t
    :bind ((:outline-minor-mode-map
            ("C-c TAB" . outline-cycle)))
    :hook ((LaTeX-mode-hook . my:add-outline-headings)
           (LaTeX-mode-hook . outline-minor-mode))
    :init
    (defun my:add-outline-headings ()
      "Custom: Add promotion headings"
      (setq outline-promotion-headings '("\\chapter"
                                         "\\section"
                                         "\\subsection"
                                         "\\subsubsection"
                                         "\\paragraph"
                                         "\\subparagraph")))
    )
  )
  #+END_SRC
* VCS
  :PROPERTIES:
  :CUSTOM_ID: orgc6b67eb9
  :END:
  まあ, ほとんど Git 関連な訳ですが．
** git{attributes,config,ignore}-mode, git-commit
   :PROPERTIES:
   :CUSTOM_ID: org429f5b00
   :END:
   #+begin_src emacs-lisp
(leaf *git
  :if (>= emacs-major-version 25)
  :init
  (leaf git-commit :ensure t)
  (leaf gitattributes-mode :ensure t)
  (leaf gitconfig-mode :ensure t)
  (leaf gitignore-mode :ensure t)
  )
   #+end_src
** magit:
   :PROPERTIES:
   :CUSTOM_ID: org59371622
   :END:
   magit は Emacs の Git Frontend.
   結局の所 CUI でコマンド叩く事も多いけれど, これはこれで重宝している．
   #+begin_src emacs-lisp
(leaf magit
  :bind (("C-x g" . magit-status))
  :ensure t
  :config
  (setq magit-completing-read-function 'ivy
        magit-refs-show-commit-count   'all
        magit-log-buffer-file-locked   t
        magit-revision-show-gravatars  nil
        )
  )
   #+end_src
** Git Gutter+
   :PROPERTIES:
   :CUSTOM_ID: org994abf0f
   :END:
   飽きたら止めるかもしれないけれど.
   #+begin_src emacs-lisp
(leaf git-gutter+
  :if (>= emacs-major-version 25)
  :ensure t
  :diminish (git-gutter+-mode
             (format "%s" (all-the-icons-octicon "git-merge")))
  :bind ("C-x G" . global-git-gutter+-mode)
  )
   #+end_src
** ghq
   :PROPERTIES:
   :CUSTOM_ID: orgf1aa4214
   :END:
   =projectile= はあんまり使わなくて良い気もしている
   #+BEGIN_SRC emacs-lisp
(leaf ivy-ghq
  :if (executable-find "ghq")
  :el-get (ivy-ghq
           :type github
           :pkgname "analyticd/ivy-ghq")
  :bind (("C-x f" . ivy-ghq-open))
  :config
  (setq ivy-ghq-short-list t)
  )
   #+END_SRC
* 関数定義を辿る: =dump-jump=, =smart-jump=
  :PROPERTIES:
  :CUSTOM_ID: org710c040c
  :END:
  あまり上手く使えていない.
  #+BEGIN_SRC emacs-lisp
(leaf dumb-jump
  :if (executable-find "rg")
  :ensure t
  :bind (("M-g o" . dumb-jump-go-other-window)
         ("M-g j" . dumb-jump-go)
         ("M-g i" . dumb-jump-go-prompt)
         ("M-g x" . dumb-jump-go-prefer-external)
         ("M-g z" . dumb-jump-go-prefer-external-other-window))
  :config
  (setq dumb-jump-selector 'ivy
        dumb-jump-force-searcher 'rg
        )
  )
(leaf smart-jump
  :ensure t
  :config
  (smart-jump-setup-default-registers)
  )
  #+END_SRC
* 言語毎の補完: =company-mode=
  :PROPERTIES:
  :CUSTOM_ID: org935a4dbf
  :END:
  まだうまく使いこなせていない．
  - [[https://qiita.com/wktkshn/items/3ac46671d1c242a59f7e][company-dabbrevで日本語を補完しない]]
  を有効にしてみたが, これで良いのかしら...?
  #+BEGIN_SRC emacs-lisp
(leaf company
  :ensure t
  :diminish company-mode
  :custom
  ((company-idle-delay            . 0)
   (company-minimum-prefix-length . 4)
   (company-selection-wrap-around . t)
   ;; disable some noisy default backends
   (company-backends . '(company-files company-capf
                                       (company-gtags
                                        company-etags
                                        company-keywords))))
  :bind
  (;; ("<tab>"    . company-indent-or-complete-common)
   (:company-active-map
    ("C-n"     . company-select-next)
    ("C-p"     . company-select-previous)
    ("C-s"     . company-filter-candidates)
    ("C-<tab>" . company-complete-common-or-cycle)
    ("<tab>"   . company-indent-or-complete-common)
    )
   (:company-search-map
    ("C-p" . company-select-previous)
    ("C-n" . company-select-next)))
  :hook
  ((after-init-hook       . global-company-mode)
   (minibuffer-setup-hook . (lambda ()
                              (company-mode -1)))
   )
  )
  #+END_SRC
  - [X] [[https://github.com/TheBB/company-reftex][TheBB/company-reftex]]
  - [X] [[https://github.com/vspinu/company-math][vspinu/company-math]]
  - [X] [[https://github.com/alexeyr/company-auctex][alexeyr/company-auctex]]
* SOMEDAY テンプレート補完: =yasnippet= [/]
  :PROPERTIES:
  :CUSTOM_ID: orgffdbe5ff
  :END:
  #+BEGIN_SRC emacs-lisp
  (leaf yasnippet
    :ensure t
    :diminish yas-minor-mode
    :disabled t
    :custom
    `((yas-indent-line  . 'fixed)
      (yas-snippet-dirs . '(,(expand-file-name "snippets" my:d:share))))
    :hook (after-init-hook . yas-global-mode)
    :bind ((yas-keymap
            ("C-<tab>" . nil)
            ("<tab>"   . nil))  ; for company
           (yas-minor-mode-map
            ("<tab>"   . nil)
            ("C-<tab>" . nil)
            ("C-c y e" . yas-expand)
            ("C-c y i" . yas-insert-snippet)
            ("C-c y n" . yas-new-snippet)
            ("C-c y v" . yas-visit-snippet-file)
            ("C-c y l" . yas-describe-tables)
            ("C-c y g" . yas-reload-all)))
    :init
    (leaf yasnippet-snippets :ensure t)
    (leaf yatemplate :ensure t)
    )
  #+END_SRC
  - [ ] 意図しない所で発火してテンプレートが挿入されてしまうので
    保留中
* TODO =flymake=: on-the-fly check [/]
  :PROPERTIES:
  :CUSTOM_ID: orgd4b6f681
  :END:
  on-the-fly syntax checker.
  同様の拡張には =flycheck= があるけれど,
  =flycheck= はいろいろやりすぎてて私には合わない.
  #+BEGIN_SRC emacs-lisp
(leaf flymake
  :if (<= 26.1 (string-to-number emacs-version))
  :ensure t
  :config
  ;; fortran: need Makefile in current directory
  ;; (push
  ;; '("\\.\\(f\\|F\\)\\(9\\|0\\)?\\(0\\|3\\)?\\'"
  ;;   flymake-proc-simple-make-init) flymake-proc-allowed-file-name-masks)
  ;; TeX: Update error pattern
  )
  #+END_SRC
  - [ ] 設定調整が必要
* LSP: =eglot=
  :PROPERTIES:
  :CUSTOM_ID: org44ddff4c
  :END:
  =lsp-mode= より設定がシンプルそうなので, こっちを試している
  #+BEGIN_SRC emacs-lisp
(leaf eglot
  ;; :disabled t
  :if (executable-find "fortls")
  :ensure t
  :hook ((f90-mode-hook . eglot-ensure))
  :config
;;  (add-hook 'f90-mode-hook 'eglot-ensure)
  (add-to-list 'eglot-server-programs
               `(f90-mode . ("fortls"
                             "--nthreads" "2"
                             "--incremental_sync"
                             "--variable_hover"
                             "--lowercase_intrinsics"
                             )))
  )
  #+END_SRC
* TeX: =AUCTeX=
  :PROPERTIES:
  :CUSTOM_ID: org88a3cb1b
  :END:
  Debian パッケージ版を使う．
  やっている事は
  - japanese-latex-mode において, 幾つかのコマンドが追加/上書きされているが,  あまり使うことの無いコマンドが表示されるのが嫌なのでそれらを削除．
  - コンパイルには[[http://personal.psu.edu/jcc8/software/latexmk/][Latexmk]]を使う
  と言った所.
  [[http://personal.psu.edu/jcc8/software/latexmk/][Latexmk]]の設定には[[https://github.com/tom-tan/auctex-latexmk][auctex-latexmk]]を利用する．
  #+BEGIN_SRC emacs-lisp
(leaf auctex
  :if (and (executable-find "uplatex")
           (executable-find "latexmk"))
  :after company
  :ensure t
  :init
  (leaf reftex
    :custom
    ((reftex-plug-into-AUCTeX               . t)
     (reftex-cite-prompt-optional-args      . t)
     (reftex-toc-split-windows-horizontally . t))
    )
  (leaf company-reftex
    :ensure t
    :hook (LaTeX-mode-hook . reftex-mode)
    )
  (leaf company-math :ensure t)
  (leaf company-auctex
    :ensure t
    :disabled t
    :hook
    (LaTeX-mode-hook . company-auctex-init)
    )
  (leaf auctex-latexmk
    :el-get (auctex-latexmk
             :type github
             :pkgname "tom-tan/auctex-latexmk")
    :hook (LaTeX-mode-hook . auctex-latexmk-setup)
    :config
    (setq auctex-latexmk-inherit-TeX-PDF-mode nil
          TeX-command-default "LaTeXMk"
          japanese-LaTeX-command-default "LaTeX"
          )
    )
  ;; auctex hook
  :hook ((LaTeX-mode-hook . (lambda ()
                              (TeX-source-correlate-mode)
                              (TeX-PDF-mode))))
  :config
  (setq japanese-TeX-engine-default 'ptex
        japanese-LaTeX-default-style "bxjsarticle"
        TeX-command-output-list '(("LaTeXMk" ("pdf")))
        TeX-engine 'ptex
        TeX-PDF-mode t
        TeX-source-correlate-method 'synctex
        TeX-source-correlate-start-server t
        TeX-source-correlate-mode t
        TeX-view-program-selection '((output-dvi "xdvi")
                                     (output-pdf "Evince")
                                     (output-html "xdg-open"))
        TeX-auto-save t
        TeX-auto-local  (expand-file-name "auctex/auto" my:d:tmp)
        TeX-style-local (expand-file-name "auctex/style" my:d:tmp)
        TeX-parse-self t
        TeX-auto-untabify t
        font-latex-fontify-script nil
        font-latex-script-display nil
        font-latex-fontify-sectioning 1.0
        )
  (with-eval-after-load 'tex-jp
    (dolist (command '("pTeX" "pLaTeX" "jTeX" "jLaTeX" "jBibTeX" "Mendex"
                       "upMendex" "pBibTeX" "BibTeX" "Biber" "Ps2pdf" ))
      (delq (assoc command TeX-command-list) TeX-command-list)))
  )
  #+END_SRC
  =~/.latexmkrc= は以下の通り
  #+begin_src perl :tangle no
#!/usr/bin/env perl
$kanji  = defined $ENV{"LATEXENC"} ? "-kanji=$ENV{\"LATEXENC\"}" : "-kanjii=utf8" ;
$latex  = "platex -interaction=nonstopmode -src-specials -shell-escape --synctex=1 $kanji";
$latex_silent = "platex -interaction=batchmode -src-specials -shell-escape --synctex=1 $kanji";
$bibtex = "pbibtex $kanji";
$makeindex = "touch -m %D";
$dvipdf = "dvipdfmx %O -o %D %S";
$dvips = 'dvips %O -z -f %S | convbkmk -u > %D';
$ps2pdf = 'ps2pdfwr %O %S %D';
$pdf_mode = 3;
$pdf_previewer = 'start xdg-open';
$pdf_update_method = 0;
$clean_ext = "snm nav vrb synctex.gz";
  #+end_src
* Autoconf
  :PROPERTIES:
  :CUSTOM_ID: org898b9a45
  :END:
  いれてみたけれど, はてさて．
  #+BEGIN_SRC emacs-lisp
(leaf sh-autoconf
  :el-get (sh-autoconf
           :type http
           :url "https://download.tuxfamily.org/user42/sh-autoconf.el")
  :mode (("/configure\\.\\(ac\\|in\\)\\'"    . sh-mode)
         ("/ac\\(include\\|local\\)\\.m4\\'" . sh-mode))
  )
  #+END_SRC
* Fortran
  :PROPERTIES:
  :CUSTOM_ID: org11ccc687
  :END:
  #+BEGIN_SRC emacs-lisp
(leaf f90
  :mode ("\\.\\(f|F\\)\\(90|95|03|08\\)$" . f90-mode)
  :init
  (leaf f90-indent
    :custom
    ((f90-do-indent               . 2)
     (f90-if-indent               . 2)
     (f90-type-indent             . 2)
     (f90-program-indent          . 2)
     (f90-continuation-indent     . 2)
     (f90-directive-comment-re    . "!omp\\$" )
     (f90-indented-comment-re     . "!" )
     (f90-break-delimiters        . "[-+\\*/><=,% \t]")
     (f90-break-before-delimiters . t)
     (f90-beginning-ampersand     . nil)
     (f90-smart-end               . 'blink)
     (f90-auto-keyword-case       . nil)
     (f90-leave-line-no           . nil)
     (f90-comment-region          . "!! ")
     (f90-indent-comment          . "! "))
    )
  )
  #+END_SRC
* Markdown
  :PROPERTIES:
  :CUSTOM_ID: org6035cc60
  :END:
  markdown自体はあまり好きじゃないんだけれど,
  必要に迫られて書く事が増えてきたので設定しておく．
  #+BEGIN_SRC emacs-lisp
(leaf markdown-mode
  :if (executable-find "pandoc")
  :mode ("\\.\\(md\\|markdown\\|mkd\\)\\'" . gfm-mode)
  :preface
  (defun my:disable-electric-indent-local-mode ()
    (electric-indent-local-mode -1))
  :hook ((markdown-mode-hook . my:disable-electric-indent-local-mode)
         (gfm-mode-hook      . my:disable-electric-indent-local-mode)
         )
  :config
  (setq markdown-command
        "pandoc --from markdown_github -t html5 --mathjax --highlight-style pygments"
        )
  )
  #+END_SRC
* SCSS
  :PROPERTIES:
  :CUSTOM_ID: org4b0a1cef
  :END:
  ちょいちょい弄る機会が増えてきたので導入．
  #+BEGIN_SRC emacs-lisp
(leaf scss-mode
  :if (executable-find "sass")
  :ensure t
  :mode "\\.scss\\'"
  :custom
  `((scss-sass-command . ,(executable-find "sass")))
  )
  #+END_SRC
* その他のモード設定
  :PROPERTIES:
  :CUSTOM_ID: orga28ad005
  :END:
  読み込むだけの mode の設定. 設定が増えたら別途まとめる。
  #+BEGIN_SRC emacs-lisp
(leaf *misc-mode
  :init
  (leaf yaml-mode
    :ensure t
    :mode "\\(\.yml\\|\.yaml\\)"
    )
  (leaf generic-x)
  (leaf textile-mode :ensure t)
  (leaf lua-mode :ensure t)
  )
  #+END_SRC
* TODO 日記: =tDiary= [0/1]
  :PROPERTIES:
  :CUSTOM_ID: org9992a617
  :END:
  #+begin_src emacs-lisp
(leaf tdiary-mode
  :if (and my:d:password-store
           (file-directory-p (concat (getenv "HOME") "/Nextcloud/tdiary")))
  :commands (tdiary-mode tdiary-replace tdiary-append)
  :el-get (tdiary-mode
           :type github
           :pkgname "uwabami/tdiary-mode")
  :defvar tdiary-passwd-file
  :pl-setq
  (tdiary-csrf-key tdiary-passwd-file)
  :config
  (setq tdiary-text-directory (concat (getenv "HOME") "/Nextcloud/tdiary/")
        tdiary-diary-list '(("log" "https://uwabami.junkhub.org/log/"))
        tdiary-style-mode 'org-mode
        tdiary-text-suffix ".org")
  (tdiary-passwd-file-load)
  )
  #+end_src
  - [ ] org2blog で tDiary を更新できないか妄想している
* テーマ, フォント, モードライン, などなど
  :PROPERTIES:
  :CUSTOM_ID: orgbf458527
  :END:
** SOMEDAY xterm-color [0/1]
   :PROPERTIES:
   :CUSTOM_ID: org4c769ff7
   :END:
   色を端末と揃える。
   #+begin_src emacs-lisp
(leaf xterm-color
  :disabled t
  :ensure t
  :config
  (setq xterm-color-names
        ["#000000"    ; black
         "#FF4C4C"    ; red
         "#4Cff4C"    ; green
         "#FFFF4C"    ; yellow
         "#4C4CFF"    ; blue
         "#FF4CFF"    ; magenta
         "#4CFFFF"    ; cyan
         "#AAAAAA"]   ; white
        xterm-color-names-bright
        ["#020202"    ; black
         "#FF7F7F"    ; red
         "#7FFF7F"    ; green
         "#FFFF7F"    ; yellow
         "#7F7FFF"    ; blue
         "#FF7FFF"    ; magenta
         "#7FFFFF"    ; cyan
         "#FFFFFF"]   ; white
        xterm-color-use-bold-for-bright nil
        )
  )
   #+end_src
   - [ ] ちゃんと効いてない, ような?
** TODO フォント [0/1]
   :PROPERTIES:
   :CUSTOM_ID: org356b9857
   :END:
  #+begin_src emacs-lisp
(defun my:load-window-config ()
  "load window-system specific settings"
  (interactive)
  (when window-system
    (progn
      (set-frame-parameter nil 'alpha 95)
      (set-face-attribute 'default nil
                          :family "FSMRMP"
                          :height 165)
      (set-face-attribute 'fixed-pitch nil
                          :family "FSMRMP"
                          :height 165)
      (set-face-attribute 'variable-pitch nil
                          :family "FSMRMP"
                          :height 165)
      ;; Math symbols
      (set-fontset-font nil
                        '(#x2200 . #x22FF)
                        (font-spec :family "Ricty" :height 165))
      ;; Greek
      (set-fontset-font nil
                        '(#x0370 . #x03FF)
                        (font-spec :family "Ricty" :height 165))
      ;; Some Icons
      (set-fontset-font nil
                        '(#xE0A0 . #xEEE0)
                        (font-spec :family "FSMRMP" :height 165))
      (setq use-default-font-for-symbols t)
      (set-frame-parameter nil 'alpha 95)
      (toggle-frame-maximized)
      )))
(when (window-system)
  (my:load-window-config))
  #+end_src
  - [ ] FSMRMP のラテン文字が全角にならない. 要調整
  #+BEGIN_EXAMPLE
幅の確認:
Greek, Math, 絵文字は全角, 他は半角で 2:1 になっているかの確認用

|abcdefghijkl|
|ABCDEFGHIJKL|
|'";:-+=/\~`?|
|∞≤≥∏∑∫|
|×±≒≡⊆⊇|
|αβγδεζ|
|ηθικλμ|
|ΑΒΓΔΕΖ|
|ΗΘΙΚΛΜ|
|日本語の美観|
|あいうえおか|
|アイウエオカ|
|ｱｲｳｴｵｶｷｸｹｺｻｼ|

| hoge                 | hogeghoe | age              |
|----------------------+----------+------------------|
| 今日もいい天気ですね | お、     | 等幅になった👍 🍺|
|----------------------+----------+------------------|
  #+END_EXAMPLE
** Major, Minor モードの表示のカスタマイズ: =diminish=, =delight=
   :PROPERTIES:
   :CUSTOM_ID: org20d8ce5c
   :END:
   基本個々のモードの設定でカスタマイズしているけれども．
   #+BEGIN_SRC emacs-lisp
(leaf *modeline-string
  ;; ここでやるより, modeline の設定時に一括で変換した方が良い気もしてきた．
  :delight ((lisp-interaction-mode
             (all-the-icons-icon-for-mode 'lisp-interaction-mode))
            (emacs-lisp-mode
             (all-the-icons-icon-for-mode 'emacs-lisp-mode))
            (text-mode
             (all-the-icons-icon-for-mode 'text-mode))
            )
  )
   #+END_SRC
** doom-modeline
   :PROPERTIES:
   :CUSTOM_ID: orge9fff107
   :END:
   細かい所が気になるので, 色々弄ってます．
   - アイコン表示の際に(EAWのせいで)幅が狂うので,
     doom-modeline内の幅の勘定をしている関数をoverride
   - SKKの表示が欲しいので追加
   - bufferのアイコンはfilenameじゃなくてmajor-modeを見にいく.
   他にも弄りたい所はあるけれど．
   #+BEGIN_SRC emacs-lisp
(leaf *doom-modeline-settings
  :diminish (;; minor-mode settings
             (isearch-mode (format " %s" (all-the-icons-faicon "search")))
             ;; (org-src-mode (format " %s" (all-the-icons-octicon "code")))
             )
  :init
  (leaf doom-modeline
    ;; :disabled t
    :ensure t
    :preface
    (defun my:doom-modeline--set-char-widths (alist)
      "Do nothing")
    :init
    ;;
    (defun my:skk-setup-modeline ()
      "skk-setup-modeline による modeline の更新を無効化"
      (eval-when-compile (require 'skk))
      (if (fboundp 'skk-make-indicator-alist)
          (setq skk-indicator-alist (skk-make-indicator-alist)))
      (force-mode-line-update t))
    ;;
    (defvar doom-modeline--buffer-file-state-icon nil)
    (defun my:doom-modeline-update-buffer-file-state-icon (&rest _)
      "Update the buffer or file state in mode-line."
      (setq doom-modeline--buffer-file-state-icon
            (ignore-errors
              (cond (buffer-read-only
                     (doom-modeline-buffer-file-state-icon
                      "lock"
                      (all-the-icons-material "lock")
                      'doom-modeline-warning))
                    ((and buffer-file-name (buffer-modified-p)
                          doom-modeline-buffer-modification-icon)
                     (doom-modeline-buffer-file-state-icon
                      "save"
                      (all-the-icons-material "save")
                      'doom-modeline-buffer-modified))
                    ((and buffer-file-name
                          (not (file-exists-p buffer-file-name)))
                     (doom-modeline-buffer-file-state-icon
                      "edit"
                      (all-the-icons-faicon "edit")
                      'doom-modeline-urgent))
                    ((or (buffer-narrowed-p)
                         (and (bound-and-true-p fancy-narrow-mode)
                              (fancy-narrow-active-p)))
                     (doom-modeline-buffer-file-state-icon
                      "vertical_align_center"
                      (all-the-icons-material "vertical_align_center")
                      'doom-modeline-warning))
                    (t
                     (doom-modeline-buffer-file-state-icon
                      "--"
                      "--"
                      (if (doom-modeline--active) 'mode-line 'mode-line-inactive)))
                    ))))
    ;;
    (defun my:doom-modeline-update-buffer-file-icon (&rest _)
      "Update file icon in mode-line, just display major-mode icon. not filename."
      (setq doom-modeline--buffer-file-icon
            (when (and doom-modeline-icon doom-modeline-major-mode-icon)
              (let* ((icon (all-the-icons-icon-for-mode major-mode)))
                (if (symbolp icon)
                    (setq icon (all-the-icons-faicon
                                "file-o"
                                :face 'all-the-icons-dsilver)))
                (unless (symbolp icon)
                  (propertize icon
                              'help-echo (format "Major-mode: %s" (format-mode-line mode-name))))))))
    ;;
    :advice ((:override doom-modeline--set-char-widths
                        my:doom-modeline--set-char-widths)
             (:override skk-setup-modeline
                        my:skk-setup-modeline))
             (:override doom-modeline-update-buffer-file-icon
                        my:doom-modeline-update-buffer-file-icon)
             (:override doom-modeline-update-buffer-file-state-icon
                        my:doom-modeline-update-buffer-file-state-icon)
    :config
    (setq doom-modeline-height 1
          doom-modeline-bar-width 0
          doom-modeline-buffer-file-name-style 'buffer-name
          doom-modeline-icon t
          doom-modeline-major-mode-icon t
          doom-modeline-major-mode-color-icon t
          doom-modeline-buffer-state-icon nil
          doom-modeline-buffer-modification-icon nil
          doom-modeline-minor-modes t
          doom-modeline-enable-word-count t
          doom-modeline-buffer-encoding t
          doom-modeline-indent-info nil
          doom-modeline-checker-simple-format t
          doom-modeline-vcs-max-length 12
          doom-modeline-persp-name t
          doom-modeline-persp-name-icon t
          doom-modeline-lsp t
          doom-modeline-github nil
          doom-modeline-github-interval (* 30 60)
          doom-modeline-mu4e nil
          doom-modeline-irc nil
          doom-modeline-irc-stylize 'identity
          doom-modeline-icons-alist
          '(;; macro
            ("fiber_manual_record"    . "\xe3cb")
            ("triangle-right"         . "\xe04c")
            ;; multiple-cursors
            ("i-cursor"               . "\xe2f7")
            ;; vcs
            ("git-compare"            . "\xe081")
            ("git-merge"              . "\xe01b")
            ("arrow-down"             . "\xe035")
            ("alert"                  . "\xe023")
            ("git-branch"             . "\xe01a")
            ;; checker: flycheck/flymake
            ("do_not_disturb_alt"     . "\xe5e5")
            ("check"                  . "\xe5ce")
            ("access_time"            . "\xe439")
            ("sim_card_alert"         . "\xe5f6")
            ("pause"                  . "\xe3a0")
            ("priority_high"          . "\xe617")
            ;; Persp
            ("aspect_ratio"           . "\xe64f")
            ;; LSP
            ("rocket"                 . "\xe029")
            ;; github
            ("github"                 . "\xe173")
            ;; debug
            ("bug"                    . "\xe245")
            ;; mu4e
            ("email"                  . "\xe3ea")
            ;; ("mail"                . "\xe158")
            ;; irc
            ("message"                . "\xe3f1")
            ;; Battery
            ("battery-charging"       . "\xebe4")
            ("battery-full"           . "\xe2f1")
            ("battery-three-quarters" . "\xe2f2")
            ("battery-half"           . "\xe2f3")
            ("battery-quarter"        . "\xe2f4")
            ("battery-empty"          . "\xe2f5")
            )
          )
    )
  :config
  ;; (eval-when-compile (require 'doom-modeline))
  (with-eval-after-load 'doom-modeline
    (doom-modeline-def-segment my:input-method-skk
      "The current ddskk status."
      (concat
       (propertize
        (cond
         ((not (boundp 'skk-modeline-input-mode))
          "[--]")
         (skk-modeline-input-mode
          (substring skk-modeline-input-mode 2 -1))
         (t
          "[--]")
         ))))
    ;;
    (doom-modeline-def-segment my:buffer-encoding
      "Displays the encoding and eol style of the buffer."
      (when doom-modeline-buffer-encoding
        (propertize
         (concat
          (let ((sys (coding-system-plist buffer-file-coding-system)))
            (cond ((memq (plist-get sys :category)
                         '(coding-category-undecided coding-category-utf-8))
                   " U")
                  ((memq (plist-get sys :name)
                         '(coding-category-undecided japanese-iso-8bit))
                   " E")
                  ((memq (plist-get sys :name)
                         '(coding-category-undecided iso-2022-jp))
                   " J")
                  ((memq (plist-get sys :name)
                         '(coding-category-undecided japanese-shift-jis))
                   " S")
                  (t " =")))
          (pcase (coding-system-eol-type buffer-file-coding-system)
            (0 "U")
            (1 "D")
            (2 "A")))
         'face (if (doom-modeline--active) 'mode-line 'mode-line-inactive)
         'help-echo 'mode-line-mule-info-help-echo
         'mouse-face '(:box 0)
         'local-map mode-line-coding-system-map)))
    ;;
    (doom-modeline-def-segment my:buffer-position
      "The buffer position information, drop nyan-mode"
      (let ((active (doom-modeline--active))
            (lc '(line-number-mode
                  (column-number-mode
                   (doom-modeline-column-zero-based " %l:%c" " %l:%C")
                   " %l")
                  (column-number-mode (doom-modeline-column-zero-based " :%c" " :%C")))))
        (propertize
         (concat (format-mode-line lc)
                 (format-mode-line '("" doom-modeline-percent-position "%%"))
                 )
         'face (if (doom-modeline--active) 'mode-line 'mode-line-inactive)
         'help-echo "Buffer position\n\
mouse-1: Display Line and Column Mode Menu"
         'mouse-face '(:box 0)
         'local-map mode-line-column-line-number-mode-map)))
    ;;
    (defvar-local doom-modeline--lsp nil)
    ;;
    ;;
    (doom-modeline-def-modeline 'main
      '(;; bar
        " "
        my:input-method-skk
        ;; workspace-name
        my:buffer-encoding
        ;; major-mode
        buffer-info
        ;; window-number
        ;; modals
        matches
        ;; remote-host
        ;; parrot
        ;; selection-info
        )
      ;;
      '(
        ;; objed-state
        ;; misc-info
        ;; persp-name
        ;; fancy-battery
        ;; grip
        ;; irc
        ;; mu4e
        ;; github
        ;; debug
        lsp
        minor-modes
        ;; indent-info
        process
        vcs
        checker
        " "
        my:buffer-position
        " "
        )
      )
    )
  (doom-modeline-mode +1)
  )
   #+END_SRC
** theme: =doom-theme=
   :PROPERTIES:
   :CUSTOM_ID: org7e722d0e
   :END:
   これまで弄っていた font-lock を
   doom-theme をベースに移植中: [[https://github.com/uwabami/emacs-doom-darkpastel][uwabami/emacs-doom-darkpastel]]
  #+begin_src emacs-lisp
;; (setq frame-background-mode (frame-parameter nil 'background-mode))
(leaf *doom-themes
  :if (>= emacs-major-version 25)
  :init
  (leaf doom-themes :ensure t)
  (leaf emacs-doom-darkpastel
    :el-get (emacs-doom-darkpastel
             :type github
             :pkgname "uwabami/emacs-doom-darkpastel"
             :prepare (add-to-list 'custom-theme-load-path default-directory)
             )
    )
  :custom
  (doom-darkpastel-set-background . nil)
  :config
  (load-theme 'doom-darkpastel t)
  ;; (eaw-and-emoji-fullwidth)
  )
  #+end_src
* 起動時間の出力
  :PROPERTIES:
  :CUSTOM_ID: orgca1f29da
  :END:
  [[http://memo.sugyan.com/entry/20120120/1327037494][起動時間を計測する 改訂版 - すぎゃーんメモ]]
  #+BEGIN_SRC emacs-lisp
(add-hook 'emacs-startup-hook
          (lambda ()
            (message "init time: %.3f sec"
                     (float-time (time-subtract after-init-time before-init-time)))))
  #+END_SRC
* LICENSE
  :PROPERTIES:
  :CUSTOM_ID: orgf87c4e84
  :END:
  幾つかの関数の元ネタとして Emacs 本体のコードを参照したので,
  GPL-3 or later です．
  #+begin_example
Copyright (C) 2011--2017 Youhei SASAKI <uwabami@gfd-dennou.org>
.
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.
.
This package is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
.
You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
  #+end_example
